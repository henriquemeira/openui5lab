/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./TableExtension","sap/ui/core/delegate/ItemNavigation","./TableUtils","./TableKeyboardDelegate2","sap/ui/Device","sap/ui/dom/containsOrEquals","sap/ui/thirdparty/jquery"],function(t,e,i,a,o,n,s){"use strict";var r=false;function l(t){if(o.browser.msie){if(!r){s("head").append('<style type="text/css">'+"/* Avoid focus outline problems in tables */\n"+".sapUiTableStatic[data-sap-ui-table-focus]{}"+"</style>");r=true}var e=i.getCellInfo(t)||{};if(e.cell){e.cell.attr("data-sap-ui-table-focus",Date.now())}}}var d={_forward:function(t,e){var i=t._getItemNavigation();if(i!=null&&!t._getKeyboardExtension()._isItemNavigationSuspended()&&!e.isMarked("sapUiTableSkipItemNavigation")){i["on"+e.type](e)}},onfocusin:function(t){d._forward(this,t);l(t.target)},onsapfocusleave:function(t){d._forward(this,t)},onmousedown:function(t){d._forward(this,t)},onsapnext:function(t){d._forward(this,t)},onsapnextmodifiers:function(t){d._forward(this,t)},onsapprevious:function(t){d._forward(this,t)},onsappreviousmodifiers:function(t){d._forward(this,t)},onsappageup:function(t){d._forward(this,t)},onsappagedown:function(t){d._forward(this,t)},onsaphome:function(t){d._forward(this,t)},onsaphomemodifiers:function(t){d._forward(this,t)},onsapend:function(t){d._forward(this,t)},onsapendmodifiers:function(t){d._forward(this,t)},onsapkeyup:function(t){d._forward(this,t)}};var f={onfocusin:function(t){var e=this._getKeyboardExtension();if(!e._bIgnoreFocusIn){e.initItemNavigation();if(u.isItemNavigationInvalid(this)){t.setMarked("sapUiTableInitItemNavigation")}}else{t.setMarked("sapUiTableIgnoreFocusIn")}if(t.target&&t.target.id===this.getId()+"-rsz"){t.preventDefault();t.setMarked("sapUiTableSkipItemNavigation")}}};var u={_initItemNavigation:function(t){var a=t.getTable();var o=a.$();var n=i.getVisibleColumnCount(a);var r=n;var l=i.hasRowHeader(a);var d=i.hasRowActions(a);var f=i.hasFixedColumns(a);var g=[],c,p,v,m,h;if(f){v=o.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowFixed:not(.sapUiTableCHT)");m=o.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowScroll:not(.sapUiTableCHT)");h=o.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowFixedBottom:not(.sapUiTableCHT)")}var _=o.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowFixed:not(.sapUiTableCHT)");var b=o.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowScroll:not(.sapUiTableCHT)");var I=o.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowFixedBottom:not(.sapUiTableCHT)");if(l){c=o.find(".sapUiTableRowHdr").get();r++}if(d){p=o.find(".sapUiTableRowAction").get();r++}for(var T=0;T<a.getVisibleRowCount();T++){if(l){g.push(c[T])}if(f){g=g.concat(v.find('tr[data-sap-ui-rowindex="'+T+'"]').find("td[tabindex]").get())}g=g.concat(_.find('tr[data-sap-ui-rowindex="'+T+'"]').find("td[tabindex]").get());if(f){g=g.concat(m.find('tr[data-sap-ui-rowindex="'+T+'"]').find("td[tabindex]").get())}g=g.concat(b.find('tr[data-sap-ui-rowindex="'+T+'"]').find("td[tabindex]").get());if(f){g=g.concat(h.find('tr[data-sap-ui-rowindex="'+T+'"]').find("td[tabindex]").get())}g=g.concat(I.find('tr[data-sap-ui-rowindex="'+T+'"]').find("td[tabindex]").get());if(d){g.push(p[T])}}if(a.getColumnHeaderVisible()){var C=[];var N=o.find(".sapUiTableCHT.sapUiTableCtrlFixed>tbody>tr");var w=o.find(".sapUiTableCHT.sapUiTableCtrlScroll>tbody>tr");for(var T=0;T<i.getHeaderRowCount(a);T++){if(l){C.push(a.getDomRef("selall"))}if(N.length){C=C.concat(s(N.get(T)).find(".sapUiTableCol").get())}if(w.length){C=C.concat(s(w.get(T)).find(".sapUiTableCol").get())}if(d){C.push(o.find(".sapUiTableRowActionHeader").children().get(0))}}g=C.concat(g)}if(!t._itemNavigation){t._itemNavigation=new e;t._itemNavigation.setTableMode(true);t._itemNavigation.attachEvent(e.Events.AfterFocus,function(e){var o=i.getFocusedItemInfo(a);o.header=i.getHeaderRowCount(a);o.domRef=null;if(o.row>=o.header){t._oLastFocusedCellInfo=o}},a)}t._itemNavigation.setColumns(r);t._itemNavigation.setRootDomRef(o.find(".sapUiTableCnt").get(0));t._itemNavigation.setItemDomRefs(g);t._itemNavigation.setFocusedIndex(u.getInitialItemNavigationIndex(t));t._itemNavigationInvalidated=false},getInitialItemNavigationIndex:function(t){return i.hasRowHeader(t.getTable())?1:0},isItemNavigationInvalid:function(t){return!t._itemNavigation||t._itemNavigationInvalidated}};var g=t.extend("sap.ui.table.TableKeyboardExtension",{_init:function(t,e,i){this._itemNavigation=null;this._itemNavigationInvalidated=false;this._itemNavigationSuspended=false;this._delegate=new a(e);this._actionMode=false;t.addEventDelegate(f,t);t.addEventDelegate(this._delegate,t);t.addEventDelegate(d,t);t._getItemNavigation=function(){return this._itemNavigation}.bind(this);return"KeyboardExtension"},_debug:function(){this._ExtensionHelper=u;this._ItemNavigationDelegate=d;this._ExtensionDelegate=f},destroy:function(){var e=this.getTable();if(e){e.removeEventDelegate(f);e.removeEventDelegate(this._delegate);e.removeEventDelegate(d)}if(this._itemNavigation){this._itemNavigation.destroy();this._itemNavigation=null}if(this._delegate){this._delegate.destroy();this._delegate=null}t.prototype.destroy.apply(this,arguments)}});g.prototype.initItemNavigation=function(){if(u.isItemNavigationInvalid(this)){u._initItemNavigation(this)}};g.prototype.invalidateItemNavigation=function(){this._itemNavigationInvalidated=true};g.prototype.setActionMode=function(t){if(t===true&&!this._actionMode&&this._delegate.enterActionMode){this._actionMode=this._delegate.enterActionMode.apply(this.getTable(),Array.prototype.slice.call(arguments,1))===true}else if(t===false&&this._actionMode&&this._delegate.leaveActionMode){this._actionMode=false;this._delegate.leaveActionMode.apply(this.getTable(),Array.prototype.slice.call(arguments,1))}};g.prototype.isInActionMode=function(){return this._actionMode};g.prototype.updateNoDataAndOverlayFocus=function(t){var e=this.getTable();if(!e||!e.getDomRef()){return}if(e.getShowOverlay()){if(n(e.getDomRef(),t)){e.$("overlay").focus()}}else if(i.isNoDataVisible(e)){if(n(e.getDomRef("sapUiTableCnt"),t)){e.$("noDataCnt").focus()}}else if(n(e.getDomRef("noDataCnt"),t)||n(e.getDomRef("overlay"),t)){i.focusItem(e,u.getInitialItemNavigationIndex(this))}};g.prototype._suspendItemNavigation=function(){this._itemNavigationSuspended=true};g.prototype._resumeItemNavigation=function(){this._itemNavigationSuspended=false};g.prototype._isItemNavigationSuspended=function(){return this._itemNavigationSuspended};g.prototype._getLastFocusedCellInfo=function(){var t=i.getHeaderRowCount(this.getTable());if(!this._oLastFocusedCellInfo||this._oLastFocusedCellInfo.header!=t){var e=i.getFocusedItemInfo(this.getTable());var a=u.getInitialItemNavigationIndex(this);return{cellInRow:a,row:t,header:t,cellCount:e.cellCount,columnCount:e.columnCount,cell:e.columnCount*t+a}}return this._oLastFocusedCellInfo};g.prototype._setSilentFocus=function(t){this._bIgnoreFocusIn=true;this._setFocus(t);this._bIgnoreFocusIn=false};g.prototype._setFocus=function(t){if(!t){return}var e=this.getTable();var a=i.getCellInfo(t);if(a.cell&&e){var o=s(t);if(o.attr("tabindex")!="0"){var n=e._getItemNavigation();if(n&&n.aItemDomRefs){for(var r=0;r<n.aItemDomRefs.length;r++){if(n.aItemDomRefs[r]){n.aItemDomRefs[r].setAttribute("tabindex","-1")}}}o.attr("tabindex","0")}}t.focus()};g.prototype._getTableType=function(){return this._type};return g});