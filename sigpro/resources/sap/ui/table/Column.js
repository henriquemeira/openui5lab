/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/core/library","sap/ui/core/Popup","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/Sorter","sap/ui/model/Type","sap/ui/model/type/String","./TableUtils","./library","./ColumnMenu","sap/base/util/ObjectPath","sap/base/util/JSTokenizer","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,t,r,i,n,o,s,a,l,u,p,g,f,h,d,y){"use strict";var c=t.HorizontalAlign,m=p.SortOrder,b=t.ValueState;var _=e.extend("sap.ui.table.Column",{metadata:{library:"sap.ui.table",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},minWidth:{type:"int",group:"Dimension",defaultValue:0},flexible:{type:"boolean",group:"Behavior",defaultValue:true,deprecated:true},resizable:{type:"boolean",group:"Behavior",defaultValue:true},hAlign:{type:"sap.ui.core.HorizontalAlign",group:"Appearance",defaultValue:c.Begin},sorted:{type:"boolean",group:"Appearance",defaultValue:false},sortOrder:{type:"sap.ui.table.SortOrder",group:"Appearance",defaultValue:m.Ascending},sortProperty:{type:"string",group:"Behavior",defaultValue:null},filtered:{type:"boolean",group:"Appearance",defaultValue:false},filterProperty:{type:"string",group:"Behavior",defaultValue:null},filterValue:{type:"string",group:"Behavior",defaultValue:null},filterOperator:{type:"string",group:"Behavior",defaultValue:null},defaultFilterOperator:{type:"string",group:"Behavior",defaultValue:null},filterType:{type:"any",group:"Misc",defaultValue:null},grouped:{type:"boolean",group:"Appearance",defaultValue:false},visible:{type:"boolean",group:"Appearance",defaultValue:true},name:{type:"string",group:"Appearance",defaultValue:null},showFilterMenuEntry:{type:"boolean",group:"Appearance",defaultValue:true},showSortMenuEntry:{type:"boolean",group:"Appearance",defaultValue:true},headerSpan:{type:"any",group:"Behavior",defaultValue:1},autoResizable:{type:"boolean",group:"Behavior",defaultValue:false}},defaultAggregation:"label",aggregations:{label:{type:"sap.ui.core.Control",altTypes:["string"],multiple:false},multiLabels:{type:"sap.ui.core.Control",multiple:true,singularName:"multiLabel"},template:{type:"sap.ui.core.Control",altTypes:["string"],multiple:false},menu:{type:"sap.ui.unified.Menu",multiple:false}},events:{columnMenuOpen:{allowPreventDefault:true,parameters:{menu:{type:"sap.ui.unified.Menu"}}}}}});_._DEFAULT_FILTER_TYPE=new l;_.prototype.init=function(){this._oSorter=null;this.mSkipPropagation={template:true};this._aTemplateClones=[]};_.prototype.exit=function(){this._destroyTemplateClones();g._destroyColumnVisibilityMenuItem()};_.prototype.setParent=function(t,r,i){var n=e.prototype.setParent.apply(this,arguments);var o=this.getAggregation("menu");if(o&&typeof o._updateReferences==="function"){o._updateReferences(this)}g._destroyColumnVisibilityMenuItem();return n};_.prototype.invalidate=function(t){if(t!==this.getTemplate()&&!u.isA(t,"sap.ui.table.ColumnMenu")){e.prototype.invalidate.apply(this,arguments)}};_.prototype.setLabel=function(e){var t=e;if(typeof e==="string"){t=p.TableHelper.createLabel({text:e})}this.setAggregation("label",t);return this};_.prototype.setTemplate=function(e){var t=e;if(typeof e==="string"){t=p.TableHelper.createTextView().bindProperty("text",e)}this.setAggregation("template",t);this.invalidate();this._destroyTemplateClones();var r=this.getParent();if(r&&r.invalidateRowsAggregation&&this.getVisible()==true){r.invalidateRowsAggregation()}return this};_.prototype.getMenu=function(){var e=this.getAggregation("menu");if(!e){e=this._createMenu();this.setMenu(e)}return e};_.prototype.invalidateMenu=function(){var e=this.getAggregation("menu");if(this._bMenuIsColumnMenu){e._invalidate()}};_.prototype._menuHasItems=function(){var e=this.getAggregation("menu");var t=this.getParent();var r=function(){return this.isSortableByMenu()||this.isFilterableByMenu()||this.isGroupable()||t&&t.getEnableColumnFreeze()||t&&t.getShowColumnVisibilityMenu()}.bind(this);return!!(e&&e.getItems().length>0||r())};_.prototype.isFilterableByMenu=function(){return!!(this.getFilterProperty()&&this.getShowFilterMenuEntry())};_.prototype.isSortableByMenu=function(){return!!(this.getSortProperty()&&this.getShowSortMenuEntry())};_.prototype.isGroupable=function(){var e=this.getParent();return!!(e&&e.getEnableGrouping&&e.getEnableGrouping()&&this.getSortProperty())};_.prototype.setMenu=function(e){this.setAggregation("menu",e,true);this._bMenuIsColumnMenu=u.isA(e,"sap.ui.table.ColumnMenu");return this};_.prototype._createMenu=function(){if(!this._defaultMenu){this._defaultMenu=new g(this.getId()+"-menu",{ariaLabelledBy:this})}return this._defaultMenu};_.prototype.setSortProperty=function(e){this.setProperty("sortProperty",e);this.invalidateMenu();return this};_.prototype.setSorted=function(e){this.setProperty("sorted",e,true);this._updateIcons();return this};_.prototype.setSortOrder=function(e){this.setProperty("sortOrder",e,true);this._updateIcons();return this};_.prototype.setFilterProperty=function(e){this.invalidateMenu();return this.setProperty("filterProperty",e)};_.prototype.setFiltered=function(e){this.setProperty("filtered",e,true);this._updateIcons();return this};_.prototype.setFilterValue=function(e){this.setProperty("filterValue",e,true);var t=this.getMenu();if(this._bMenuIsColumnMenu){t._setFilterValue(e)}return this};_.prototype.setFilterOperator=function(e){return this.setProperty("filterOperator",e,true)};_.prototype._openMenu=function(e,t){var i=this.getMenu();var n=this.fireColumnMenuOpen({menu:i});if(n){var o=r.Dock;var s=e;if(!e){e=this.getDomRef();s=this.getFocusDomRef()}i.open(!!t,s,o.BeginTop,o.BeginBottom,e,"none none")}};_.prototype.toggleSort=function(){this.sort(this.getSorted()&&this.getSortOrder()===m.Ascending)};_.prototype.sort=function(e,t){var r=this.getParent();if(r){r.pushSortedColumn(this,t);var i=e?m.Descending:m.Ascending;var n=r.fireSort({column:this,sortOrder:i,columnAdded:t});if(n){var o=r.getSortedColumns();var a=r.getColumns();for(var l=0,u=a.length;l<u;l++){if(o.indexOf(a[l])<0){a[l].setProperty("sorted",false,true);a[l].setProperty("sortOrder",m.Ascending,true);a[l]._updateIcons();delete a[l]._oSorter}}this.setProperty("sorted",true,true);this.setProperty("sortOrder",i,true);this._oSorter=new s(this.getSortProperty(),this.getSortOrder()===m.Descending);var p=[];for(var l=0,u=o.length;l<u;l++){o[l]._updateIcons();p.push(o[l]._oSorter)}var g=r.getBinding("rows");if(g){if(this._updateTableAnalyticalInfo){this._updateTableAnalyticalInfo(true)}g.sort(p)}else{d.warning("Sorting not performed because no binding present",this)}}}return this};_.prototype._updateIcons=function(){var e=this.getParent(),t=this.getSorted(),r=this.getFiltered();if(!e||!e.getDomRef()){return}this.$().parents(".sapUiTableCHT").find('td[data-sap-ui-colindex="'+this.getIndex()+'"]:not([colspan]):not(.sapUiTableColInvisible):first .sapUiTableColCell').toggleClass("sapUiTableColSF",t||r).toggleClass("sapUiTableColFiltered",r).toggleClass("sapUiTableColSorted",t).toggleClass("sapUiTableColSortedD",t&&this.getSortOrder()===m.Descending);e._getAccExtension().updateAriaStateOfColumn(this);e._resetColumnHeaderHeights();e._updateRowHeights(e._collectRowHeights(true),true)};_.prototype._renderSortIcon=function(){this._updateIcons()};_.prototype._getFilter=function(){var e,t=this.getFilterProperty(),r=this.getFilterValue(),o=this.getFilterOperator(),s,a,u=this.getFilterType()||_._DEFAULT_FILTER_TYPE,p=u instanceof l,g;if(r){if(!o){g=r.match(/(.*)\s*\.\.\s*(.*)/);if(r.indexOf("=")==0){o=n.EQ;s=r.substr(1)}else if(r.indexOf("!=")==0){o=n.NE;s=r.substr(2)}else if(r.indexOf("<=")==0){o=n.LE;s=r.substr(2)}else if(r.indexOf("<")==0){o=n.LT;s=r.substr(1)}else if(r.indexOf(">=")==0){o=n.GE;s=r.substr(2)}else if(r.indexOf(">")==0){o=n.GT;s=r.substr(1)}else if(g){if(g[1]&&g[2]){o=n.BT;s=g[1];a=g[2]}else if(g[1]&&!g[2]){o=n.GE;s=g[1]}else{o=n.LE;s=g[2]}}else if(p&&r.indexOf("*")==0&&r.lastIndexOf("*")==r.length-1){o=n.Contains;s=r.substr(1,r.length-2)}else if(p&&r.indexOf("*")==0){o=n.EndsWith;s=r.substr(1)}else if(p&&r.lastIndexOf("*")==r.length-1){o=n.StartsWith;s=r.substr(0,r.length-1)}else{if(this.getDefaultFilterOperator()){o=this.getDefaultFilterOperator()}else{if(p){o=n.Contains}else{o=n.EQ}}s=r.substr(0)}if(!a){e=new i(t,o,this._parseFilterValue(s))}else{e=new i(t,o,this._parseFilterValue(s),this._parseFilterValue(a))}}else{e=new i(t,o,this._parseFilterValue(r))}}return e};_.prototype.filter=function(e){var t=this.getParent();if(t&&t.isBound("rows")){var r=t.fireFilter({column:this,value:e});if(r){this.setProperty("filtered",!!e,true);this.setProperty("filterValue",e,true);var i=this.getMenu();if(this._bMenuIsColumnMenu){i._setFilterValue(e)}var n=[];var s=t.getColumns();for(var a=0,l=s.length;a<l;a++){var u=s[a],p;i=u.getMenu();try{p=u._getFilter();if(u._bMenuIsColumnMenu){i._setFilterState(b.None)}}catch(e){if(u._bMenuIsColumnMenu){i._setFilterState(b.Error)}continue}if(p){n.push(p)}}t.getBinding("rows").filter(n,o.Control);this._updateIcons()}}return this};_.prototype._parseFilterValue=function(e){var t=this.getFilterType();if(t){if(y.isFunction(t)){e=t(e)}else{e=t.parseValue(e,"string")}}return e};_.prototype._restoreIcons=function(){this._updateIcons()};_.prototype.shouldRender=function(){return this.getVisible()&&!this.getGrouped()&&this.getTemplate()!=null};_.PROPERTIES_FOR_ROW_INVALIDATION={visible:true,flexible:true,headerSpan:true};_.prototype.setProperty=function(t,r){var i=this.getParent();if(i&&i.invalidateRowsAggregation&&this.getProperty(t)!=r&&_.PROPERTIES_FOR_ROW_INVALIDATION[t]&&(this.getVisible()||t=="visible")){i.invalidateRowsAggregation()}return e.prototype.setProperty.apply(this,arguments)};_.prototype.setFilterType=function(e){var t=e;if(typeof e==="string"){try{var r=h.parseJS(e);if(typeof r.type==="string"){var i=f.get(r.type);t=i&&new i(r.formatOptions,r.constraints)}}catch(r){var i=f.get(e);t=i&&new i}if(!(t instanceof a)){d.error("The filter type is not an instance of sap.ui.model.Type! Ignoring the filter type!");t=undefined}}this.setProperty("filterType",t,true);return this};_.prototype.getIndex=function(){var e=this.getParent();if(e){return e.indexOfColumn(this)}else{return-1}};_.prototype._getFreeTemplateClone=function(){var e=null;for(var t=0;t<this._aTemplateClones.length;t++){if(!this._aTemplateClones[t]||this._aTemplateClones[t].bIsDestroyed){this._aTemplateClones.splice(t,1);t--}else if(!e&&!this._aTemplateClones[t].getParent()){e=this._aTemplateClones[t]}}return e};_.prototype.getTemplateClone=function(e){if(e==null){return null}var t=this._getFreeTemplateClone();if(!t){var r=this.getTemplate();if(r){t=r.clone();this._aTemplateClones.push(t)}}if(t){t.data("sap-ui-colindex",e);t.data("sap-ui-colid",this.getId());var i=this.getParent();if(i){i._getAccExtension().addColumnHeaderLabel(this,t)}}return t};_.prototype._destroyTemplateClones=function(){for(var e=0;e<this._aTemplateClones.length;e++){if(this._aTemplateClones[e]!=null&&!this._aTemplateClones[e].bIsDestroyed){this._aTemplateClones[e].destroy()}}this._aTemplateClones=[]};_.prototype._closeMenu=function(){var e=this.getAggregation("menu");if(e){e.close()}};_.prototype.setVisible=function(e){this.setProperty("visible",e);g._updateVisibilityIcon(this.getIndex(),e)};return _});