/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/model/Sorter","sap/ui/Device","./library","sap/ui/thirdparty/jquery"],function(e,r,t,a,o){"use strict";var n={TableUtils:null,clearMode:function(e){e._mode=null},setGroupMode:function(e){e._mode="Group"},isGroupMode:function(e){return e._mode=="Group"},setTreeMode:function(e){e._mode="Tree"},isTreeMode:function(e){return e._mode=="Tree"},getModeCssClass:function(e){switch(e._mode){case"Group":return"sapUiTableGroupMode";case"Tree":return"sapUiTableTreeMode";default:return null}},showGroupMenuButton:function(e){if(e._bShowGroupMenuButton===true||e._bShowGroupMenuButton===false){return e._bShowGroupMenuButton}if(!t.system.desktop&&e.isA("sap.ui.table.AnalyticalTable")){e._bShowGroupMenuButton=true}else{e._bShowGroupMenuButton=false}return e._bShowGroupMenuButton},toggleGroupHeader:function(e,r,t){var a=[];var o=e?e.getBinding("rows"):null;if(!e||!o||!o.expand||r==null){return null}if(typeof r==="number"){a=[r]}else if(Array.isArray(r)){if(t==null&&r.length>1){return null}a=r}var n=e._getTotalRowCount(true);var i=a.filter(function(e){var r=o.isExpanded(e);var a=true;if(o.nodeHasChildren){if(o.getNodeByIndex){a=!o.nodeHasChildren(o.getNodeByIndex(e))}else{a=false}}return e>=0&&e<n&&!a&&t!==r}).sort();if(i.length===0){return null}for(var l=i.length-1;l>0;l--){if(t){o.expand(i[l],true)}else{o.collapse(i[l],true)}}if(t===true){o.expand(i[0],false)}else if(t===false){o.collapse(i[0],false)}else{o.toggleIndex(i[0])}return o.isExpanded(i[0])},toggleGroupHeaderByRef:function(e,r,t){var a=o(r);var i;if(a.hasClass("sapUiTableTreeIcon")||n.isTreeMode(e)&&a.hasClass("sapUiTableTdFirst")){i=a.closest("tr",e.getDomRef())}else{i=a.closest(".sapUiTableGroupHeader",e.getDomRef())}var l=e.getBinding("rows");if(i.length>0&&l){var s=i.data("sap-ui-rowindex");var u=e.getRows()[s];if(u){var d=u.getIndex();var p=n.toggleGroupHeader(e,d,t);var f=p===true||p===false;if(f&&e._onGroupHeaderChanged){e._onGroupHeaderChanged(d,p)}return f}}return false},isInGroupingRow:function(e){var r=n.TableUtils.getCellInfo(e);if(r.isOfType(n.TableUtils.CELLTYPE.DATACELL)){return r.cell.parent().hasClass("sapUiTableGroupHeader")}else if(r.isOfType(n.TableUtils.CELLTYPE.ROWHEADER|n.TableUtils.CELLTYPE.ROWACTION)){return r.cell.hasClass("sapUiTableGroupHeader")}return false},isGroupingRow:function(e){if(!e){return false}return o(e).hasClass("sapUiTableGroupHeader")},isInSumRow:function(e){var r=n.TableUtils.getCellInfo(e);if(r.isOfType(n.TableUtils.CELLTYPE.DATACELL)){return r.cell.parent().hasClass("sapUiAnalyticalTableSum")}else if(r.isOfType(n.TableUtils.CELLTYPE.ROWHEADER|n.TableUtils.CELLTYPE.ROWACTION)){return r.cell.hasClass("sapUiAnalyticalTableSum")}return false},_calcGroupIndent:function(e,r,t,a){if(e.isA("sap.ui.table.TreeTable")){var o=0;for(var n=0;n<r;n++){o=o+(n<2?12:8)}return o}else if(e.isA("sap.ui.table.AnalyticalTable")){var o=0;r=r-1;r=!t&&!a?r-1:r;r=Math.max(r,0);for(var n=0;n<r;n++){if(o==0){o=12}o=o+(n<2?12:8)}return o}else{var o=0;r=!t?r-1:r;r=Math.max(r,0);for(var n=0;n<r;n++){o=o+(n<2?12:8)}return o}},_setIndent:function(e,r,t,a){var o=e._bRtlMode,n=r.find("td.sapUiTableTdFirst > .sapUiTableCell"),i=t.find(".sapUiTableGroupShield");if(a<=0){t.css(o?"right":"left","");i.css("width","").css(o?"margin-right":"margin-left","");n.css(o?"padding-right":"padding-left","")}else{t.css(o?"right":"left",a+"px");i.css("width",a+"px").css(o?"margin-right":"margin-left",-1*a+"px");n.css(o?"padding-right":"padding-left",a+8+"px")}},updateTableRowForGrouping:function(e,r,t,a,i,l,s,u){var d=r.getDomRefs(true),p=d.row,f=d.rowScrollPart,g=d.rowFixedPart,c=d.rowSelector,T=d.rowAction;p.attr({"data-sap-ui-level":s});p.data("sap-ui-level",s);if(n.isGroupMode(e)){p.toggleClass("sapUiAnalyticalTableSum",!t&&l).toggleClass("sapUiAnalyticalTableDummy",false).toggleClass("sapUiTableGroupHeader",t).toggleClass("sapUiTableRowHidden",t&&i||r._bHidden);o(document.getElementById(r.getId()+"-groupHeader")).toggleClass("sapUiTableGroupIconOpen",t&&a).toggleClass("sapUiTableGroupIconClosed",t&&!a).attr("title",e._getShowStandardTooltips()&&u?u:null).text(u||"");n._setIndent(e,p,c,n._calcGroupIndent(e,s,t,l))}var _=null;if(n.isTreeMode(e)){_=p.find(".sapUiTableTreeIcon");_.css(e._bRtlMode?"margin-right":"margin-left",s*17+"px").toggleClass("sapUiTableTreeIconLeaf",!t).toggleClass("sapUiTableTreeIconNodeOpen",t&&a).toggleClass("sapUiTableTreeIconNodeClosed",t&&!a)}if(n.showGroupMenuButton(e)){var b=0;var v=e.$();if(v.hasClass("sapUiTableVScr")){b+=v.find(".sapUiTableVSb").width()}var h=c.find(".sapUiTableGroupMenuButton");if(e._bRtlMode){h.css("right",v.width()-h.width()+c.position().left-b-5+"px")}else{h.css("left",v.width()-h.width()-c.position().left-b-5+"px")}}e._getAccExtension().updateAriaExpandAndLevelState(r,f,c,g,T,t,a,s,_)},cleanupTableRowForGrouping:function(e,r){var t=r.getDomRefs(true);t.row.removeAttr("data-sap-ui-level");t.row.removeData("sap-ui-level");if(n.isGroupMode(e)){t.row.removeClass("sapUiTableGroupHeader sapUiAnalyticalTableSum sapUiAnalyticalTableDummy");n._setIndent(e,t.row,t.rowSelector,0)}var a=null;if(n.isTreeMode(e)){a=t.row.find(".sapUiTableTreeIcon");a.removeClass("sapUiTableTreeIconLeaf").removeClass("sapUiTableTreeIconNodeOpen").removeClass("sapUiTableTreeIconNodeClosed").css(this._bRtlMode?"margin-right":"margin-left","")}e._getAccExtension().updateAriaExpandAndLevelState(r,t.rowScrollPart,t.rowSelector,t.rowFixedPart,t.rowAction,false,false,-1,a)},updateGroups:function(e){if(n.isGroupMode(e)||n.isTreeMode(e)){var r=e.getBinding("rows"),t=e.getBindingInfo("rows"),a=e.getRows(),o=a.length;if(r){var i;for(var l=0;l<o;l++){i=n._getRowGroupInfo(e,a[l],r,t);n.updateTableRowForGrouping(e,a[l],i.isHeader,i.expanded,i.hidden,false,i.level,i.title)}}else{for(var l=0;l<o;l++){n.cleanupTableRowForGrouping(e,a[l])}}}},_getRowGroupInfo:function(e,r,t,a){var o={isHeader:false,expanded:false,hidden:false,title:"",level:0};if(e.getGroupHeaderProperty){o.isHeader=r._bHasChildren;o.expanded=r._bIsExpanded;o.hidden=o.isHeader;o.level=r._iLevel;var i=e.getGroupHeaderProperty();if(n.isGroupMode(e)&&i){var l=a&&a.model;o.title=e.getModel(l).getProperty(i,r.getBindingContext(l))}}else{var s=r.getIndex();o.isHeader=!!t.isGroupHeader(s);o.level=o.isHeader?0:1;if(o.isHeader){o.expanded=!!t.isExpanded(s);o.hidden=true;o.title=t.getTitle(s)}}return o},setupExperimentalGrouping:function(t){if(!t.getEnableGrouping()){return}var a=e.prototype.getBinding.call(t,"rows");var i=sap.ui.getCore().byId(t.getGroupBy());var l=i&&i.getGrouped()&&n.TableUtils.isA(a,"sap.ui.model.ClientListBinding");if(!l||a._modified){return}a._modified=true;n.setGroupMode(t);var s=i.getSortProperty();a.sort(new r(s));var u=t._getTotalRowCount(),d=a.getContexts(0,u);var p;var f=0;for(var g=u-1;g>=0;g--){var c=d[g].getProperty(s);if(!p){p=c}if(p!==c){var T=d[g+1].getModel().getContext("/sap.ui.table.GroupInfo"+g);T.__groupInfo={oContext:d[g+1],name:p,count:f,groupHeader:true,expanded:true};d.splice(g+1,0,T);p=c;f=0}f++}var T=d[0].getModel().getContext("/sap.ui.table.GroupInfo");T.__groupInfo={oContext:d[0],name:p,count:f,groupHeader:true,expanded:true};d.splice(0,0,T);o.extend(a,{getLength:function(){return d.length},getContexts:function(e,r){return d.slice(e,e+r)},isGroupHeader:function(e){var r=d[e];return(r&&r.__groupInfo&&r.__groupInfo.groupHeader)===true},getTitle:function(e){var r=d[e];return r&&r.__groupInfo&&r.__groupInfo.name+" - "+r.__groupInfo.count},isExpanded:function(e){var r=d[e];return this.isGroupHeader(e)&&r.__groupInfo&&r.__groupInfo.expanded},expand:function(e){if(this.isGroupHeader(e)&&!d[e].__groupInfo.expanded){for(var r=0;r<d[e].__childs.length;r++){d.splice(e+1+r,0,d[e].__childs[r])}delete d[e].__childs;d[e].__groupInfo.expanded=true;this._fireChange()}},collapse:function(e){if(this.isGroupHeader(e)&&d[e].__groupInfo.expanded){d[e].__childs=d.splice(e+1,d[e].__groupInfo.count);d[e].__groupInfo.expanded=false;this._fireChange()}},toggleIndex:function(e){if(this.isExpanded(e)){this.collapse(e)}else{this.expand(e)}},nodeHasChildren:function(e){if(!e||!e.__groupInfo){return false}else{return e.__groupInfo.groupHeader===true}},getNodeByIndex:function(e){return d[e]}});t._mTimeouts.groupingFireBindingChange=t._mTimeouts.groupingFireBindingChange||window.setTimeout(function(){a._fireChange()},0)},resetExperimentalGrouping:function(e){var r=e.getBinding("rows");if(r&&r._modified){n.clearMode(e);var t=e.getBindingInfo("rows");e.unbindRows();e.bindRows(t)}}};return n},true);