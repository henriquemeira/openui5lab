/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","./TableExtension","./TableUtils","sap/ui/Device","sap/ui/core/Popup","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/scrollLeftRTL","sap/ui/dom/jquery/control"],function(e,t,i,o,n,s,l){"use strict";var r=e.SelectionMode;var a=["sapMBtnBase","sapMInputBase","sapMLnk","sapMSlt","sapMCb","sapMRI","sapMSegBBtn","sapUiIconPointer","sapMBtnIcon"];var d={_getEventPosition:function(e,t){var i;function o(i){if(!t._isTouchEvent(i)){return null}var o=["touches","targetTouches","changedTouches"];for(var n=0;n<o.length;n++){var s=o[n];if(e[s]&&e[s][0]){return e[s][0]}if(e.originalEvent[s]&&e.originalEvent[s][0]){return e.originalEvent[s][0]}}return null}i=o(e)||e;return{x:i.pageX,y:i.pageY}},_skipClick:function(e,t,o){if(!o.isOfType(i.CELLTYPE.DATACELL|i.CELLTYPE.ROWACTION)){return false}if(e.isMarked()){return true}var n=t.control(0);if(n){var l=n.$();if(l.length){for(var r=0;r<a.length;r++){if(l.hasClass(a[r])){return typeof n.getEnabled==="function"?n.getEnabled():true}}}}var d=false;if(window.getSelection){var u=window.getSelection();d=u.rangeCount?!u.getRangeAt(0).collapsed:false}if(d){s.debug("DOM Selection detected -> Click event on table skipped, Target: "+e.target);return true}return false},_handleClickSelection:function(e,t,n){i.toggleRowSelection(n,t,null,function(t){if((o.browser.msie||o.browser.edge)&&e.shiftKey){n._clearTextSelection()}var i=n.getSelectionMode();if(i===r.Single){if(!n.isIndexSelected(t)){n.setSelectedIndex(t)}else{n.clearSelection()}}else if(e.shiftKey){var s=n.getSelectedIndex();if(s>=0){n.addSelectionInterval(s,t)}else{n.setSelectedIndex(t)}}else if(!n._legacyMultiSelection){if(!n.isIndexSelected(t)){n.addSelectionInterval(t,t)}else{n.removeSelectionInterval(t,t)}}else{n._legacyMultiSelection(t,e)}return true})}};var u={initColumnResizing:function(e,t){if(e._bIsColumnResizerMoving){return}e._bIsColumnResizerMoving=true;e.$().toggleClass("sapUiTableResizing",true);var i=l(document),o=e._isTouchEvent(t);e._$colResize=e.$("rsz");e._iColumnResizeStart=d._getEventPosition(t,e).x;i.bind((o?"touchend":"mouseup")+".sapUiTableColumnResize",u.exitColumnResizing.bind(e));i.bind((o?"touchmove":"mousemove")+".sapUiTableColumnResize",u.onMouseMoveWhileColumnResizing.bind(e));e._disableTextSelection()},exitColumnResizing:function(e){u._resizeColumn(this,this._iLastHoveredColumnIndex)},onMouseMoveWhileColumnResizing:function(e){var t=d._getEventPosition(e,this).x;if(this._iColumnResizeStart&&t<this._iColumnResizeStart+3&&t>this._iColumnResizeStart-3){return}if(this._isTouchEvent(e)){e.stopPropagation();e.preventDefault()}this._$colResize.toggleClass("sapUiTableColRszActive",true);var o=this._getVisibleColumns()[this._iLastHoveredColumnIndex];var n=t-this._iColumnResizeStart;var s=this.$().find('th[data-sap-ui-colid="'+o.getId()+'"]').width();var l=Math.max(s+n*(this._bRtlMode?-1:1),i.Column.getMinColumnWidth());var r=this.$().find(".sapUiTableCnt").offset().left;var a=Math.floor(t-r-this._$colResize.width()/2);this._$colResize.css("left",a+"px");o._iNewWidth=l},_cleanupColumResizing:function(e){if(e._$colResize){e._$colResize.toggleClass("sapUiTableColRszActive",false);e._$colResize=null}e._iColumnResizeStart=null;e._bIsColumnResizerMoving=false;e.$().toggleClass("sapUiTableResizing",false);e._enableTextSelection();var t=l(document);t.unbind("touchmove.sapUiTableColumnResize");t.unbind("touchend.sapUiTableColumnResize");t.unbind("mousemove.sapUiTableColumnResize");t.unbind("mouseup.sapUiTableColumnResize")},_resizeColumn:function(e,t){var o=e._getVisibleColumns();var n;if(t>=0&&t<o.length){n=o[t];if(n._iNewWidth){i.Column.resizeColumn(e,e.indexOfColumn(n),n._iNewWidth);delete n._iNewWidth}}u._cleanupColumResizing(e);n.focus()},doAutoResizeColumn:function(e,t){var i=e._getVisibleColumns(),o;if(t>=0&&t<i.length){o=i[t];if(!o.getAutoResizable()||!o.getResizable()){return}var n=u._calculateAutomaticColumnWidth.apply(e,[o,t]);if(n){o._iNewWidth=n;u._resizeColumn(e,t)}}},_calculateAutomaticColumnWidth:function(e,t){e=e||this.getColumns()[t];var o=this.$();var n=l("<div>").addClass("sapUiTableHiddenSizeDetector");o.append(n);var s=o.find('td[data-sap-ui-colid = "'+e.getId()+'"]:not([colspan])').filter(function(e,t){return t.style.display!="none"}).children().clone();s.find("[id]").removeAttr("id");var r=n.append(s).width()+4;r=Math.min(r,o.find(".sapUiTableCnt").width());r=Math.max(r+4,i.Column.getMinColumnWidth());n.remove();return r},initColumnTracking:function(e){e.$().find(".sapUiTableCtrlScr, .sapUiTableCtrlScrFixed").mousemove(function(e){var t=this.getDomRef();if(!t||this._bIsColumnResizerMoving){return}var i=e.clientX,o=t.getBoundingClientRect(),n=0,s=this._bRtlMode?1e4:-1e4;for(var l=0;l<this._aTableHeaders.length;l++){var r=this._aTableHeaders[l].getBoundingClientRect();if(this._bRtlMode){if(i<r.right-5&&i>=r.left){n=l;s=r.left-o.left;break}}else{if(i>r.left+5&&i<=r.right){n=l;s=r.right-o.left;break}}}var a=this._getVisibleColumns()[n];if(a&&a.getResizable()){this.$("rsz").css("left",s+"px");this._iLastHoveredColumnIndex=n}}.bind(e))}};var h={initInteractiveResizing:function(e,t){var i=l(document.body),o=e.$("sb"),n=l(document),s=o.offset(),r=o.height(),a=o.width(),d=e._isTouchEvent(t);i.bind("selectstart",h.onSelectStartWhileInteractiveResizing);i.append('<div id="'+e.getId()+'-ghost" class="sapUiTableInteractiveResizerGhost" style =" height:'+r+"px; width:"+a+"px; left:"+s.left+"px; top:"+s.top+'px" ></div>');o.append('<div id="'+e.getId()+'-rzoverlay" style ="left: 0px; right: 0px; bottom: 0px; top: 0px; position:absolute" ></div>');n.bind((d?"touchend":"mouseup")+".sapUiTableInteractiveResize",h.exitInteractiveResizing.bind(e));n.bind((d?"touchmove":"mousemove")+".sapUiTableInteractiveResize",h.onMouseMoveWhileInteractiveResizing.bind(e));e._disableTextSelection()},exitInteractiveResizing:function(e){var t=l(document.body),o=l(document),n=this.$(),s=this.$("ghost"),r=d._getEventPosition(e,this).y;var a=r-n.find(".sapUiTableCCnt").offset().top-s.height()-n.find(".sapUiTableFtr").height();this._updateRows(this._calculateRowsToDisplay(a),i.RowsUpdateReason.Resize);this._setRowContentHeight(a);s.remove();this.$("rzoverlay").remove();t.unbind("selectstart",h.onSelectStartWhileInteractiveResizing);o.unbind("touchend.sapUiTableInteractiveResize");o.unbind("touchmove.sapUiTableInteractiveResize");o.unbind("mouseup.sapUiTableInteractiveResize");o.unbind("mousemove.sapUiTableInteractiveResize");this._enableTextSelection()},onSelectStartWhileInteractiveResizing:function(e){e.preventDefault();e.stopPropagation();return false},onMouseMoveWhileInteractiveResizing:function(e){var t=d._getEventPosition(e,this).y;var i=this.$().offset().top;if(t>i){this.$("ghost").css("top",t+"px")}}};var c={initReordering:function(e,t,o){var s=e.getColumns()[t],r=s.$(),a=e.$();e._disableTextSelection();a.addClass("sapUiTableDragDrop");var d=r.clone();d.find("*").addBack(d).removeAttr("id").removeAttr("data-sap-ui").removeAttr("tabindex");d.attr("id",e.getId()+"-roghost").addClass("sapUiTableColReorderGhost").css({left:-1e4,top:-1e4,"z-index":n.getNextZIndex()});d.toggleClass(i.getContentDensity(e),true);d.appendTo(document.body);e._$ReorderGhost=e.getDomRef("roghost");a.find("td[data-sap-ui-colid='"+s.getId()+"']").toggleClass("sapUiTableColReorderFade",true);var u=l("<div id='"+e.getId()+"-roind' class='sapUiTableColReorderIndicator'><div class='sapUiTableColReorderIndicatorArrow'></div><div class='sapUiTableColReorderIndicatorInner'></div></div>");u.appendTo(e.getDomRef("sapUiTableCnt"));e._$ReorderIndicator=e.getDomRef("roind");e._iDnDColIndex=t;var h=l(document),f=e._isTouchEvent(o);h.bind((f?"touchend":"mouseup")+".sapUiColumnMove",c.exitReordering.bind(e));h.bind((f?"touchmove":"mousemove")+".sapUiColumnMove",c.onMouseMoveWhileReordering.bind(e))},onMouseMoveWhileReordering:function(e){var t=d._getEventPosition(e,this),o=t.x,n=t.y,s=this._iNewColPos;this._iNewColPos=this._iDnDColIndex;e.preventDefault();var r=c.findColumnForPosition(this,o);if(!r||!r.id){this._iNewColPos=s;return}var a=40,u=this.getDomRef("sapUiTableColHdrScr"),h=l(u),f=u.getBoundingClientRect(),v=h.outerWidth(),g=this._bRtlMode?h.scrollLeftRTL():h.scrollLeft();this._bReorderScroll=false;if(o>f.left+v-a&&g+v<u.scrollWidth){this._bReorderScroll=true;c.doScroll(this,!this._bRtlMode);c.adaptReorderMarkerPosition(this,r,false)}else if(o<f.left+a&&g>0){this._bReorderScroll=true;c.doScroll(this,this._bRtlMode);c.adaptReorderMarkerPosition(this,r,false)}l(this._$ReorderGhost).css({left:o+5,top:n+5});if(this._bReorderScroll||!r){return}if(r.before||r.after&&r.index==this._iDnDColIndex){this._iNewColPos=r.index}else if(r.after&&r.index!=this._iDnDColIndex){this._iNewColPos=r.index+1}if(!i.Column.isColumnMovableTo(this.getColumns()[this._iDnDColIndex],this._iNewColPos)){this._iNewColPos=s}else{c.adaptReorderMarkerPosition(this,r,true)}},exitReordering:function(e){var t=this._iDnDColIndex;var o=this._iNewColPos;var n=l(document);n.unbind("touchmove.sapUiColumnMove");n.unbind("touchend.sapUiColumnMove");n.unbind("mousemove.sapUiColumnMove");n.unbind("mouseup.sapUiColumnMove");this._bReorderScroll=false;this.$().removeClass("sapUiTableDragDrop");delete this._iDnDColIndex;delete this._iNewColPos;l(this._$ReorderGhost).remove();delete this._$ReorderGhost;l(this._$ReorderIndicator).remove();delete this._$ReorderIndicator;this.$().find(".sapUiTableColReorderFade").removeClass("sapUiTableColReorderFade");this._enableTextSelection();i.Column.moveColumnTo(this.getColumns()[t],o);if(this._mTimeouts.reApplyFocusTimerId){window.clearTimeout(this._mTimeouts.reApplyFocusTimerId)}var s=this;this._mTimeouts.reApplyFocusTimerId=window.setTimeout(function(){var t=i.getFocusedItemInfo(s).cell;i.focusItem(s,0,e);i.focusItem(s,t,e)},0)},findColumnForPosition:function(e,t){var i,o,n,s,r,a,d;for(var u=0;u<e._aTableHeaders.length;u++){i=e._aTableHeaders[u];o=l(i);n=i.getBoundingClientRect();s=o.outerWidth();r={left:n.left,center:n.left+s/2,right:n.left+s,width:s,index:parseInt(o.attr("data-sap-ui-headcolindex")),id:o.attr("data-sap-ui-colid")};a=t>=r.left&&t<=r.center;d=t>=r.center&&t<=r.right;if(a||d){r.before=e._bRtlMode?d:a;r.after=e._bRtlMode?a:d;return r}}return null},doScroll:function(e,t){if(e._mTimeouts.horizontalReorderScrollTimerId){window.clearTimeout(e._mTimeouts.horizontalReorderScrollTimerId);e._mTimeouts.horizontalReorderScrollTimerId=null}if(e._bReorderScroll){var i=t?30:-30;if(e._bRtlMode){i=-1*i}e._mTimeouts.horizontalReorderScrollTimerId=setTimeout(c.doScroll.bind(e,e,t),60);var o=e.$("sapUiTableColHdrScr");var n=e._bRtlMode?"scrollLeftRTL":"scrollLeft";o[n](o[n]()+i)}},adaptReorderMarkerPosition:function(e,t,i){if(!t||!e._$ReorderIndicator){return}var o=t.left-e.getDomRef().getBoundingClientRect().left;if(e._bRtlMode&&t.before||!e._bRtlMode&&t.after){o=o+t.width}l(e._$ReorderIndicator).css({left:o+"px"}).toggleClass("sapUiTableColReorderIndicatorActive",i)}};var f={ROWAREAS:[".sapUiTableRowHdr",".sapUiTableRowAction",".sapUiTableCtrlFixed > tbody > .sapUiTableTr",".sapUiTableCtrlScroll > tbody > .sapUiTableTr"],initRowHovering:function(e){var t=e.$();for(var i=0;i<f.ROWAREAS.length;i++){f._initRowHoveringForArea(e,t,f.ROWAREAS[i])}},_initRowHoveringForArea:function(e,t,i){t.find(i).hover(function(){f._onHover(e,t,i,this)},function(){f._onUnhover(e,t,i,this)})},_onHover:function(e,t,i,o){var n=t.find(i).index(o);e.getRows()[n]._setHovered(true)},_onUnhover:function(e,t,i,o){var n=t.find(i).index(o);e.getRows()[n]._setHovered(false)}};var v={onmousedown:function(e){var t=this._getPointerExtension();var n=i.getCell(this,e.target);var s=i.getCellInfo(n);var r=l(e.target);var a;var c;var f;this._getKeyboardExtension().initItemNavigation();if(e.button===0){if(e.target===this.getDomRef("sb")){h.initInteractiveResizing(this,e)}else if(e.target===this.getDomRef("rsz")){e.preventDefault();e.stopPropagation();u.initColumnResizing(this,e)}else if(r.hasClass("sapUiTableColResizer")){var v=r.closest(".sapUiTableCol").attr("data-sap-ui-colindex");this._iLastHoveredColumnIndex=parseInt(v);u.initColumnResizing(this,e)}else if(s.isOfType(i.CELLTYPE.COLUMNHEADER)){a=this.getColumns()[s.columnIndex];c=a.getAggregation("menu");f=c&&c.bOpen;if(!f){t._bShowMenu=true;this._mTimeouts.delayedMenuTimerId=setTimeout(function(){delete t._bShowMenu},200)}if(this.getEnableColumnReordering()&&!(this._isTouchEvent(e)&&r.hasClass("sapUiTableColDropDown"))){this._getPointerExtension().doReorderColumn(s.columnIndex,e)}}if(o.browser.firefox&&!!(e.metaKey||e.ctrlKey)||r.closest(".sapUiTableHSb",this.getDomRef()).length===1||r.closest(".sapUiTableVSb",this.getDomRef()).length===1){e.preventDefault()}}if(e.button===2){if(d._skipClick(e,r,s)){t._bShowDefaultMenu=true;return}if(s.isOfType(i.CELLTYPE.COLUMNHEADER)){a=this.getColumns()[s.columnIndex];c=a.getAggregation("menu");f=c&&c.bOpen;if(!f){t._bShowMenu=true}else{t._bHideMenu=true}}else if(s.isOfType(i.CELLTYPE.ANYCONTENTCELL)){if(i.Menu.hasContextMenu(this)){t._bShowMenu=true}else{f=this._oCellContextMenu&&this._oCellContextMenu.bOpen;var g=f&&this._oCellContextMenu.oOpenerRef!==n[0];if(!f||g){t._bShowMenu=true}else{t._bHideMenu=true}}}else{t._bShowDefaultMenu=true}}},onmouseup:function(e){clearTimeout(this._mTimeouts.delayedColumnReorderTimerId)},ondblclick:function(e){if(o.system.desktop&&e.target===this.getDomRef("rsz")){e.preventDefault();u.doAutoResizeColumn(this,this._iLastHoveredColumnIndex)}},onclick:function(e){clearTimeout(this._mTimeouts.delayedColumnReorderTimerId);if(e.isMarked()){return}var t=l(e.target);if(t.hasClass("sapUiAnalyticalTableSum")){e.preventDefault();return}else if(t.hasClass("sapUiTableGroupMenuButton")){this._onContextMenu(e);e.preventDefault();return}else if(t.hasClass("sapUiTableGroupIcon")||t.hasClass("sapUiTableTreeIcon")){if(i.Grouping.toggleGroupHeaderByRef(this,e.target)){return}}var o=i.getCell(this,e.target);var n=i.getCellInfo(o);if(n.isOfType(i.CELLTYPE.COLUMNHEADER)){var s=this._getPointerExtension();if(s._bShowMenu){i.Menu.openContextMenu(this,e.target,false);delete s._bShowMenu}}else{if(d._skipClick(e,t,n)){return}if(!this._findAndfireCellEvent(this.fireCellClick,e)){if(n.isOfType(i.CELLTYPE.COLUMNROWHEADER)){this._toggleSelectAll()}else{d._handleClickSelection(e,o,this)}}else{e.preventDefault()}}},oncontextmenu:function(e){var t=this._getPointerExtension();if(t._bShowDefaultMenu){e.setMarked("handledByPointerExtension");delete t._bShowDefaultMenu}else if(t._bShowMenu){e.setMarked("handledByPointerExtension");e.preventDefault();i.Menu.openContextMenu(this,e.target,false,null,e);delete t._bShowMenu}else if(t._bHideMenu){e.setMarked("handledByPointerExtension");e.preventDefault();delete t._bHideMenu}}};var g=t.extend("sap.ui.table.TablePointerExtension",{_init:function(e,i,o){this._delegate=v;e.addEventDelegate(this._delegate,e);e._iLastHoveredColumnIndex=0;e._bIsColumnResizerMoving=false;e._iFirstReorderableIndex=i==t.TABLETYPES.TREE?1:0;return"PointerExtension"},_attachEvents:function(){var e=this.getTable();if(e){u.initColumnTracking(e);f.initRowHovering(e)}},_detachEvents:function(){var e=this.getTable();if(e){var t=e.$();t.find(".sapUiTableCtrlScr, .sapUiTableCtrlScrFixed").unbind();t.find(".sapUiTableCtrl > tbody > tr").unbind();t.find(".sapUiTableRowHdr").unbind()}},_debug:function(){this._ExtensionHelper=d;this._ColumnResizeHelper=u;this._InteractiveResizeHelper=h;this._ReorderHelper=c;this._ExtensionDelegate=v;this._RowHoverHandler=f;this._KNOWNCLICKABLECONTROLS=a},doAutoResizeColumn:function(e){var t=this.getTable();if(t){u.doAutoResizeColumn(t,e)}},doReorderColumn:function(e,t){var o=this.getTable();if(o&&i.Column.isColumnMovable(o.getColumns()[e])){o._mTimeouts.delayedColumnReorderTimerId=setTimeout(function(){c.initReordering(this,e,t)}.bind(o),200)}},destroy:function(){var e=this.getTable();if(e){e.removeEventDelegate(this._delegate)}this._delegate=null;t.prototype.destroy.apply(this,arguments)}});return g});