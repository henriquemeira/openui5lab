/*
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/core/syncStyleClass","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,t,r,a){"use strict";var i=e.extend("sap.ui.table.TablePersoController",{constructor:function(t,r){e.apply(this,arguments)},metadata:{properties:{autoSave:{type:"boolean",defaultValue:true},persoService:{type:"any"},customDataKey:{type:"string",defaultValue:"persoKey"}},associations:{table:{type:"sap.ui.table.Table",multiple:false}},library:"sap.ui.table"}});i.prototype.init=function(){this._schemaProperty="_persoSchemaVersion";this._schemaVersion="1.0";this._oInitialPersoData=null;this._aTableEvents=["columnResize","columnMove","columnVisibility","sort","filter","group"];this._aColumnProperties=["visible","width","sorted","sortOrder","grouped","summed"];this._bSaveFilters=false;if(this._bSaveFilters){this._aTableEvents.push("filter");this._aColumnProperties.push("filtered");this._aColumnProperties.push("filterValue")}};i.prototype.exit=function(){var e=this._getTable();if(e){this._manageTableEventHandlers(e,false)}delete this._schemaProperty;delete this._schemaVersion;delete this._oInitialPersoData;if(this._oDialog){this._oDialog.destroy();delete this._oDialog}};i.prototype.setPersoService=function(e){e=this.validateProperty("persoService",e);if(e&&(!a.isFunction(e.getPersData)||!a.isFunction(e.setPersData)||!a.isFunction(e.delPersData))){throw new Error('Value of property "persoService" needs to be null/undefined or an object that has the methods '+'"getPersData", "setPersData" and "delPersData".')}var t=this.getPersoService();this.setProperty("persoService",e,true);var r=this.getPersoService();if(r&&r!==t&&this._getTable()&&(this.getAutoSave()||!t)){this.refresh()}return this};i.prototype.setAutoSave=function(e){var t=this.getAutoSave();this.setProperty("autoSave",e,true);var r=this.getAutoSave();if(r&&!t){this.savePersonalizations()}return this};i.prototype.setTable=function(e){var t=this._getTable();if(t){t._oPersoController=undefined}this.setAssociation("table",e,true);var r=this._getTable();if(r){r._oPersoController=this}if(t){this._manageTableEventHandlers(t,false)}if(r&&r!==t){this._oInitialPersoData=this._getCurrentTablePersoData(true);this._manageTableEventHandlers(r,true);if(this.getPersoService()&&(this.getAutoSave()||!t)){this.refresh()}}else if(!r){this._oInitialPersoData=null}return this};i.prototype.setCustomDataKey=function(e){var t=this.getCustomDataKey();this.setProperty("customDataKey",e,true);var r=this.getCustomDataKey();if(t!==r&&this.getAutoSave()){this.savePersonalizations()}return this};i.prototype._manageTableEventHandlers=function(e,t){for(var r=0,a=this._aTableEvents.length;r<a;r++){var i=e[t?"attachEvent":"detachEvent"];i.apply(e,[this._aTableEvents[r],this._tableEventHandler,this])}};i.prototype.refresh=function(){var e=this;var t=this.getPersoService();if(t){return t.getPersData().done(function(t){var r=t&&Array.isArray(t.aColumns)?t:e._oInitialPersoData;e._adjustTable(r)}).fail(function(){r.error("Problem reading persisted personalization data.")})}else{r.error("The Personalization Service is not available!");var i=a.Deferred();i.reject();return i.promise()}};i.prototype.savePersonalizations=function(){var e=this.getPersoService();if(e){var t=this._getCurrentTablePersoData();t[this._schemaProperty]=this._schemaVersion;return e.setPersData(t).fail(function(){r.error("Problem persisting personalization data.")})}else{r.error("The Personalization Service is not available!");var i=a.Deferred();i.reject();return i.promise()}};i.prototype._adjustTable=function(e){var t=this._getTable();if(!t||!e||!Array.isArray(e.aColumns)){return}var a={},i=t.getColumns();for(var o=0,s=i.length;o<s;o++){a[this._getColumnPersoKey(i[o])]=i[o]}var n=e.aColumns;for(var o=0,s=n.length;o<s;o++){var l=n[o];var u=a[l.id];if(u){if(t.indexOfColumn(u)!==l.order){t.removeColumn(u);t.insertColumn(u,l.order)}var h=u.getMetadata();for(var p=0,g=this._aColumnProperties.length;p<g;p++){var v=this._aColumnProperties[p];if(l[v]!==undefined){try{if(h.hasProperty(v)&&u.getProperty(v)!=l[v]){u.setProperty(v,l[v])}}catch(e){r.error('sap.ui.table.TablePersoController: failed to apply the value "'+u[v]+'" for the property + "'+v+'".')}}}}}if(typeof t._onPersoApplied==="function"){t._onPersoApplied()}};i.prototype._tableEventHandler=function(e){if(this.getAutoSave()&&!this._iTriggerSaveTimeout){var t=this;this._iTriggerSaveTimeout=setTimeout(function(){t.savePersonalizations();t._iTriggerSaveTimeout=null},0)}};i.prototype._getCurrentTablePersoData=function(e){var t=this._getTable(),r=t.getColumns();var a={aColumns:[]};for(var i=0,o=r.length;i<o;i++){var s=r[i];var n=this._getColumnPersoKey(s);var l={id:n,order:i};var u=s.getMetadata();for(var h=0,p=this._aColumnProperties.length;h<p;h++){var g=this._aColumnProperties[h];if(u.hasProperty(g)){l[g]=s.getProperty(g)}}if(e){l.text=s.getLabel()&&s.getLabel().getText()||n}a.aColumns.push(l)}return a};i.prototype._getTable=function(){return sap.ui.getCore().byId(this.getTable())};i.prototype._getColumnPersoKey=function(e){return this._getPersoKey(this._getTable())+"-"+this._getPersoKey(e)};i.prototype._getPersoKey=function(e){var t=e.data(this.getCustomDataKey());if(!t){t=e.getId();if(t.indexOf(sap.ui.getCore().getConfiguration().getUIDPrefix())===0){r.warning('Generated IDs should not be used as personalization keys! The stability cannot be ensured! (Control: "'+e.getId()+'")')}}return t};i.prototype.openDialog=function(e){var r=this;function a(){if(r._oDialog){t("sapUiSizeCompact",r._getTable(),r._oDialog._oDialog);r._oDialog.open()}}if(!this._oDialog){sap.ui.getCore().loadLibrary("sap.m",{async:true}).then(function(){sap.ui.require(["sap/m/TablePersoDialog"],function(t){r._oDialog=new t(r._getTable().getId()+"-PersoDialog",{persoService:r.getPersoService(),showSelectAll:true,showResetAll:true,grouping:false,contentWidth:e&&e.contentWidth,contentHeight:e&&e.contentHeight||"20rem",initialColumnState:r._oInitialPersoData.aColumns,columnInfoCallback:function(e,t,a){return r._getCurrentTablePersoData(true).aColumns},confirm:function(){r._adjustTable(this.retrievePersonalizations());if(r.getAutoSave()){r.savePersonalizations()}}});r._oDialog._oDialog.removeStyleClass("sapUiPopupWithPadding");a()})})}else{a()}};return i});