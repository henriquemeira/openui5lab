/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./AnalyticalColumn","./Table","./TreeTable","./TableRenderer","./library","sap/ui/model/analytics/ODataModelAdapter","sap/ui/model/SelectionModel","sap/ui/model/Sorter","sap/ui/core/Popup","sap/ui/unified/Menu","sap/ui/unified/MenuItem","./TableUtils","./BindingSelectionAdapter","sap/base/Log","sap/base/assert","sap/ui/thirdparty/jquery"],function(e,t,o,r,n,a,i,u,s,p,l,d,f,g,h,c){"use strict";var m=n.GroupEventType,y=n.SortOrder,_=n.TreeAutoExpandMode;var v=t.extend("sap.ui.table.AnalyticalTable",{metadata:{library:"sap.ui.table",properties:{sumOnTop:{type:"boolean",group:"Appearance",defaultValue:false,deprecated:true},numberOfExpandedLevels:{type:"int",group:"Misc",defaultValue:0,deprecated:true},autoExpandMode:{type:"string",group:"Misc",defaultValue:"Bundled",deprecated:true},columnVisibilityMenuSorter:{type:"any",group:"Appearance",defaultValue:null},collapseRecursive:{type:"boolean",defaultValue:true},dirty:{type:"boolean",group:"Appearance",defaultValue:null,deprecated:true}},designtime:"sap/ui/table/designtime/AnalyticalTable.designtime"},renderer:"sap.ui.table.TableRenderer"});v.prototype._getFixedBottomRowContexts=function(){var e=this.getBinding("rows");if(e){return[e.getGrandTotalNode()]}};v.prototype._getContexts=o.prototype._getContexts;v.prototype.init=function(){t.prototype.init.apply(this,arguments);this.addStyleClass("sapUiAnalyticalTable");this.attachBrowserEvent("contextmenu",this._onContextMenu);this.setShowColumnVisibilityMenu(true);this.setEnableColumnFreeze(true);this.setEnableCellFilter(true);this._aGroupedColumns=[];this._bSuspendUpdateAnalyticalInfo=false;d.Grouping.setGroupMode(this)};v.prototype._initSelectionAdapter=o.prototype._initSelectionAdapter;v.prototype.exit=function(){this._cleanupGroupHeaderMenu();t.prototype.exit.apply(this,arguments)};v.prototype._adaptLocalization=function(e,o){return t.prototype._adaptLocalization.apply(this,arguments).then(function(){if(o){this._cleanupGroupHeaderMenu()}}.bind(this))};v.prototype.setFixedRowCount=function(){g.error("The property fixedRowCount is not supported by control sap.ui.table.AnalyticalTable!");return this};v.prototype.setFixedBottomRowCount=function(){g.error("The property fixedBottomRowCount is managed by control sap.ui.table.AnalyticalTable!");return this};v.prototype.setDirty=function(e){g.error("The property dirty of control sap.ui.table.AnalyticalTable is deprecated. Please use showOverlay instead.");this.setProperty("dirty",e,true);this.setShowOverlay(this.getDirty());return this};v.prototype.setEnableGrouping=function(){g.error("The property enableGrouping is not supported by the sap.ui.table.AnalyticalTable control");return this};v.prototype.setGroupBy=function(){g.warning("The groupBy association is not supported by the sap.ui.table.AnalyticalTable control");return this};v.prototype.getModel=function(e){var o=t.prototype.getModel.apply(this,arguments);var r=this.getBindingInfo("rows");if(o&&r&&r.model==e){a.apply(o)}return o};v.prototype._onBindingChange=function(e){t.prototype._onBindingChange.apply(this,arguments);var o=typeof e==="object"?e.getParameter("reason"):e;if(o!=="sort"){this._invalidateColumnMenus()}};v.prototype._bindAggregation=function(e,o){if(e==="rows"){this.setProperty("firstVisibleRow",0,true);this._applyAnalyticalBindingInfo(o);this._updateTotalRow(true);this._applyODataModelAnalyticalAdapter(o.model);t._addBindingListener(o,"selectionChanged",this._onSelectionChanged.bind(this))}t.prototype._bindAggregation.call(this,e,o);if(e==="rows"){d.Binding.metadataLoaded(this).then(function(){this._updateColumns(true)}.bind(this))}};v.prototype._applyAnalyticalBindingInfo=function(e){var t=this.getColumns();for(var o=0,r=t.length;o<r;o++){if(t[o].getSorted()){e.sorter=e.sorter||[];e.sorter.push(new u(t[o].getSortProperty()||t[o].getLeadingProperty(),t[o].getSortOrder()===y.Descending))}}e.parameters=e.parameters||{};e.parameters.analyticalInfo=this._getColumnInformation();if(!e.parameters.hasOwnProperty("sumOnTop")){e.parameters.sumOnTop=this.getSumOnTop()}if(!e.parameters.hasOwnProperty("numberOfExpandedLevels")){e.parameters.numberOfExpandedLevels=this.getNumberOfExpandedLevels()}if(e.parameters.numberOfExpandedLevels>this._aGroupedColumns.length){e.parameters.numberOfExpandedLevels=0}if(!e.parameters.hasOwnProperty("autoExpandMode")){var n=this.getAutoExpandMode();if(n!=_.Bundled&&n!=_.Sequential){n=_.Bundled}e.parameters.autoExpandMode=n}};v.prototype._applyODataModelAnalyticalAdapter=function(e){if(e){a.apply(e)}};v.prototype._getColumnInformation=function(){var t=[],o=this.getColumns();for(var r=0;r<this._aGroupedColumns.length;r++){var n=sap.ui.getCore().byId(this._aGroupedColumns[r]);if(!n){continue}t.push({name:n.getLeadingProperty(),visible:n.getVisible(),grouped:n.getGrouped(),total:n.getSummed(),sorted:n.getSorted(),sortOrder:n.getSortOrder(),inResult:n.getInResult(),formatter:n.getGroupHeaderFormatter()})}for(var r=0;r<o.length;r++){var n=o[r];if(this._aGroupedColumns.indexOf(n.getId())>-1){continue}if(!n instanceof e){g.error("You have to use AnalyticalColumns for the Analytical table")}t.push({name:n.getLeadingProperty(),visible:n.getVisible(),grouped:n.getGrouped(),total:n.getSummed(),sorted:n.getSorted(),sortOrder:n.getSortOrder(),inResult:n.getInResult(),formatter:n.getGroupHeaderFormatter()})}return t};v.prototype._updateTableContent=function(){var e=this.getBinding("rows"),t=this.getFirstVisibleRow(),o=this.getFixedBottomRowCount(),r=this.getVisibleRowCount(),n=this.getColumns();var a=this.getRows();if(!e){for(var i=0;i<a.length;i++){d.Grouping.cleanupTableRowForGrouping(this,a[i])}return}var u=this.getBindingInfo("rows");for(var s=0,p=Math.min(r,a.length);s<p;s++){var l=s>r-o-1&&this._getTotalRowCount()>r,f=l?this._getTotalRowCount()-1-(r-1-s):t+s,g=a[s],h=g.$(),m=this.$().find("div[data-sap-ui-rowindex="+h.attr("data-sap-ui-rowindex")+"]");var y;if(l&&e.bProvideGrandTotals){y=e.getGrandTotalContextInfo()}else{y=this.getContextInfoByIndex(f)}var _=y?y.level:0;if(!y||!y.context){d.Grouping.cleanupTableRowForGrouping(this,g);if(y&&!y.context){h.addClass("sapUiAnalyticalTableDummy");m.addClass("sapUiAnalyticalTableDummy")}continue}if(e.nodeHasChildren&&e.nodeHasChildren(y)){d.Grouping.updateTableRowForGrouping(this,g,true,y.nodeState.expanded,y.nodeState.expanded&&!u.parameters.sumOnTop,false,_,e.getGroupName(y.context,y.level))}else{d.Grouping.updateTableRowForGrouping(this,g,false,false,false,y.nodeState.sum,_,y.nodeState.sum&&y.level>0?e.getGroupName(y.context,y.level):null)}var v=g.getCells();for(var i=0,C=v.length;i<C;i++){var G=v[i].data("sap-ui-colindex");var b=n[G];var x=c(v[i].$().closest("td"));if(e.isMeasure(b.getLeadingProperty())){x.addClass("sapUiTableMeasureCell");x.toggleClass("sapUiTableCellHidden",y.nodeState.sum&&!b.getSummed())}else{x.removeClass("sapUiTableMeasureCell")}}}};v.prototype._onContextMenu=function(e){if(c(e.target).closest("tr").hasClass("sapUiTableGroupHeader")||c(e.target).closest(".sapUiTableRowHdr.sapUiTableGroupHeader").length>0){this._iGroupedLevel=c(e.target).closest("[data-sap-ui-level]").data("sap-ui-level");var t=this._getGroupHeaderMenu();var o=s.Dock;var r=e.pageX||e.clientX;var n=e.pageY||e.clientY;t.open(false,e.target,o.LeftTop,o.LeftTop,document,r-2+" "+(n-2));e.preventDefault();e.stopPropagation();return}return true};v.prototype._getGroupHeaderMenu=function(){var e=this;function t(){var t=e._iGroupedLevel-1;if(e._aGroupedColumns[t]){var o=e.getColumns().filter(function(o){return e._aGroupedColumns[t]===o.getId()})[0];return{column:o,index:t}}else{return undefined}}if(!this._oGroupHeaderMenu){this._oGroupHeaderMenu=new p;this._oGroupHeaderMenuVisibilityItem=new l({text:d.getResourceText("TBL_SHOW_COLUMN"),select:function(){var o=t();if(o){var r=o.column,n=r.getShowIfGrouped();r.setShowIfGrouped(!n);e.fireGroup({column:r,groupedColumns:r.getParent()._aGroupedColumns,type:!n?m.showGroupedColumn:m.hideGroupedColumn})}}});this._oGroupHeaderMenu.addItem(this._oGroupHeaderMenuVisibilityItem);this._oGroupHeaderMenu.addItem(new l({text:d.getResourceText("TBL_UNGROUP"),select:function(){var o=t();if(o&&o.column){var r=o.column;r.setGrouped(false);e.fireGroup({column:r,groupedColumns:e._aGroupedColumns,type:m.ungroup})}}}));this._oGroupHeaderMenu.addItem(new l({text:d.getResourceText("TBL_UNGROUP_ALL"),select:function(){var t=e.getColumns();e.suspendUpdateAnalyticalInfo();for(var o=0;o<t.length;o++){t[o].setGrouped(false)}e.resumeUpdateAnalyticalInfo();e.fireGroup({column:undefined,groupedColumns:[],type:m.ungroupAll})}}));this._oGroupHeaderMoveUpItem=new l({text:d.getResourceText("TBL_MOVE_UP"),select:function(){var o=t();if(o){var r=o.column;var n=e._aGroupedColumns.indexOf(r.getId());if(n>0){e._aGroupedColumns[n]=e._aGroupedColumns.splice(n-1,1,e._aGroupedColumns[n])[0];e.updateAnalyticalInfo();e.fireGroup({column:r,groupedColumns:r.getParent()._aGroupedColumns,type:m.moveUp})}}},icon:"sap-icon://arrow-top"});this._oGroupHeaderMenu.addItem(this._oGroupHeaderMoveUpItem);this._oGroupHeaderMoveDownItem=new l({text:d.getResourceText("TBL_MOVE_DOWN"),select:function(){var o=t();if(o){var r=o.column;var n=e._aGroupedColumns.indexOf(r.getId());if(n<e._aGroupedColumns.length){e._aGroupedColumns[n]=e._aGroupedColumns.splice(n+1,1,e._aGroupedColumns[n])[0];e.updateAnalyticalInfo();e.fireGroup({column:r,groupedColumns:r.getParent()._aGroupedColumns,type:m.moveDown})}}},icon:"sap-icon://arrow-bottom"});this._oGroupHeaderMenu.addItem(this._oGroupHeaderMoveDownItem);this._oGroupHeaderMenu.addItem(new l({text:d.getResourceText("TBL_SORT_ASC"),select:function(){var e=t();if(e){var o=e.column;o.sort(false)}},icon:"sap-icon://up"}));this._oGroupHeaderMenu.addItem(new l({text:d.getResourceText("TBL_SORT_DESC"),select:function(){var e=t();if(e){var o=e.column;o.sort(true)}},icon:"sap-icon://down"}));this._oGroupHeaderMenu.addItem(new l({text:d.getResourceText("TBL_COLLAPSE_LEVEL"),select:function(){e.getBinding("rows").collapseToLevel(e._iGroupedLevel-1);e.setFirstVisibleRow(0);e.clearSelection()}}));this._oGroupHeaderMenu.addItem(new l({text:d.getResourceText("TBL_COLLAPSE_ALL"),select:function(){e.getBinding("rows").collapseToLevel(0);e.setFirstVisibleRow(0);e.clearSelection()}}))}var o=t();if(o){var r=o.column;if(r.getShowIfGrouped()){this._oGroupHeaderMenuVisibilityItem.setText(d.getResourceText("TBL_HIDE_COLUMN"))}else{this._oGroupHeaderMenuVisibilityItem.setText(d.getResourceText("TBL_SHOW_COLUMN"))}this._oGroupHeaderMoveUpItem.setEnabled(o.index>0);this._oGroupHeaderMoveDownItem.setEnabled(o.index<this._aGroupedColumns.length-1)}else{this._oGroupHeaderMoveUpItem.setEnabled(true);this._oGroupHeaderMoveDownItem.setEnabled(true)}return this._oGroupHeaderMenu};v.prototype._cleanupGroupHeaderMenu=function(){if(this._oGroupHeaderMenu){this._oGroupHeaderMenu.destroy();this._oGroupHeaderMenu=null;this._oGroupHeaderMenuVisibilityItem=null;this._oGroupHeaderMoveUpItem=null;this._oGroupHeaderMoveDownItem=null}};v.prototype.getContextByIndex=function(e){var t=this.getBinding("rows");return e>=0&&t?t.getContextByIndex(e):null};v.prototype.getContextInfoByIndex=function(e){var t=this.getBinding("rows");return e>=0&&t?t.getNodeByIndex(e):null};v.prototype.suspendUpdateAnalyticalInfo=function(){this._bSuspendUpdateAnalyticalInfo=true};v.prototype.resumeUpdateAnalyticalInfo=function(e,t){this._bSuspendUpdateAnalyticalInfo=false;this._updateColumns(e,t)};v.prototype.addColumn=function(e,o){var r=this._getColumn(e);if(r.getGrouped()){this._addGroupedColumn(r.getId())}t.prototype.addColumn.call(this,r,o);this._updateColumns(o);return this};v.prototype.insertColumn=function(e,o,r){var n=this._getColumn(e);if(n.getGrouped()){this._addGroupedColumn(n.getId())}t.prototype.insertColumn.call(this,n,o,r);this._updateColumns(r);return this};v.prototype.removeColumn=function(e,o){var r=t.prototype.removeColumn.apply(this,arguments);if(!this._bReorderInProcess){this._aGroupedColumns=c.grep(this._aGroupedColumns,function(t){if(e.getId){return t!=e.getId()}else{return t==e}})}this.updateAnalyticalInfo(o);return r};v.prototype.removeAllColumns=function(e){this._aGroupedColumns=[];var o=t.prototype.removeAllColumns.apply(this,arguments);this._updateColumns(e);return o};v.prototype._getColumn=function(t){if(typeof t==="string"){var o=new e({leadingProperty:t,template:t,managed:true});return o}else if(t instanceof e){return t}else{throw new Error("Wrong column type. You need to define a string (property) or pass an AnalyticalColumnObject")}};v.prototype._updateColumns=function(e,t){if(!this._bSuspendUpdateAnalyticalInfo){this._updateTableColumnDetails();this.updateAnalyticalInfo(e,t);if(this.bOutput){this.invalidate()}}};v.prototype.updateAnalyticalInfo=function(e,t){if(this._bSuspendUpdateAnalyticalInfo){return}var o=this.getBinding("rows");if(o){var r=this._getColumnInformation();var n=o.getNumberOfExpandedLevels()||0;if(n>this._aGroupedColumns.length){o.setNumberOfExpandedLevels(0)}o.updateAnalyticalInfo(r,t);this._updateTotalRow(e);if(!e){this._getRowContexts()}}};v.prototype.refreshRows=function(){t.prototype.refreshRows.apply(this,arguments);this._updateTotalRow()};v.prototype._updateTotalRow=function(e){var t=this.getBinding("rows");var o=this.getFixedBottomRowCount();if(t&&(t.providesGrandTotal()&&t.hasTotaledMeasures())){if(o!==1){this.setProperty("fixedBottomRowCount",1,e)}}else{if(o!==0){this.setProperty("fixedBottomRowCount",0,e)}}};v.prototype._updateTableColumnDetails=function(){if(this._bSuspendUpdateAnalyticalInfo){return}var e=this.getBinding("rows"),t=e&&e.getAnalyticalQueryResult();if(t){var o=this.getColumns(),r=[],n=[],a=[],i={},u,s;for(var p=0;p<o.length;p++){u=o[p];u._isLastGroupableLeft=false;u._bLastGroupAndGrouped=false;u._bDependendGrouped=false;if(!u.getVisible()){continue}var l=u.getLeadingProperty();s=t.findDimensionByPropertyName(l);if(s){var d=s.getName();if(!i[d]){i[d]={dimension:s,columns:[u]}}else{i[d].columns.push(u)}if(u.getGrouped()&&r.indexOf(d)==-1){r.push(d)}if(a.indexOf(d)==-1){a.push(d)}}}n=c.grep(a,function(e){return r.indexOf(r,e)==-1});if(r.length>0){c.each(r,function(e,t){c.each(i[t].columns,function(e,t){if(!t.getGrouped()){t._bDependendGrouped=true}})});if(r.length==a.length){s=t.findDimensionByPropertyName(sap.ui.getCore().byId(this._aGroupedColumns[this._aGroupedColumns.length-1]).getLeadingProperty());var f=i[s.getName()].columns;c.each(f,function(e,t){t._bLastGroupAndGrouped=true})}}if(n.length==1){c.each(i[n[0]].columns,function(e,t){t._isLastGroupableLeft=true})}}};v.prototype._getFirstMeasureColumnIndex=function(){var e=this.getBinding("rows"),t=e&&e.getAnalyticalQueryResult(),o=this._getVisibleColumns();if(!t){return-1}for(var r=0;r<o.length;r++){var n=o[r],a=n.getLeadingProperty();if(t.findMeasureByName(a)||t.findMeasureByPropertyName(a)){return r}}};v.prototype.getTotalSize=function(){var e=this.getBinding("rows");if(e){return e.getTotalSize()}return 0};v.prototype._onPersoApplied=function(){t.prototype._onPersoApplied.apply(this,arguments);this._aGroupedColumns=[];var e=this.getColumns();for(var o=0,r=e.length;o<r;o++){if(e[o].getGrouped()){this._addGroupedColumn(e[o].getId())}}this._updateColumns()};v.prototype._addGroupedColumn=function(e){if(this._aGroupedColumns.indexOf(e)===-1){this._aGroupedColumns.push(e)}};v.prototype._removeGroupedColumn=function(e){var t=this._aGroupedColumns.indexOf(e);if(t>=0){this._aGroupedColumns.splice(t,1)}};v.prototype.getGroupedColumns=function(){return this._aGroupedColumns};v.prototype.setCollapseRecursive=function(e){var t=this.getBinding("rows");if(t){h(t.setCollapseRecursive,"Collapse Recursive is not supported by the used binding");if(t.setCollapseRecursive){t.setCollapseRecursive(e)}}this.setProperty("collapseRecursive",!!e,true);return this};v.prototype.expand=o.prototype.expand;v.prototype.collapse=o.prototype.collapse;v.prototype.collapseAll=o.prototype.collapseAll;v.prototype.isExpanded=o.prototype.isExpanded;v.prototype.getAnalyticalInfoOfRow=function(e){if(!this._validateRow(e)){return null}var t=this.getBindingInfo("rows");var o=this.getBinding("rows");if(!t||!o){return null}var r=e.getBindingContext(t.model);if(!r){return null}var n=r===o.getGrandTotalContext();var a=null;var i=-1;if(n){a=o.getGrandTotalContextInfo();i=0}else{a=this.getContextInfoByIndex(e.getIndex());if(a){i=a.level}}var u=a&&o.nodeHasChildren&&o.nodeHasChildren(a);var s=!u&&!n&&a&&a.nodeState&&a.nodeState.sum;var p=[];if(s||u){var l=this.getGroupedColumns();if(l.length>0&&i>0&&i<=l.length){for(var d=0;d<i;d++){p.push(l[d])}}}return{grandTotal:n,group:u,groupTotal:s,level:i,context:r,groupedColumns:p}};return v});