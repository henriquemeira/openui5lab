/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/table/TableUtils","./library","sap/ui/core/Icon","sap/ui/unified/Menu","sap/ui/core/Popup","./RowActionRenderer","sap/ui/events/KeyCodes","sap/ui/thirdparty/jquery"],function(t,e,i,s,o,n,a,r,l){"use strict";var u=t.extend("sap.ui.table.RowAction",{metadata:{library:"sap.ui.table",properties:{visible:{type:"boolean",group:"Misc",defaultValue:true}},defaultAggregation:"items",aggregations:{items:{type:"sap.ui.table.RowActionItem",multiple:true},_icons:{type:"sap.ui.core.Icon",multiple:true,visibility:"hidden"},_menu:{type:"sap.ui.unified.Menu",multiple:false,visibility:"hidden"}},events:{}}});u.prototype.init=function(){var t=function(t){this.setAggregation("tooltip",t,true);this.setSrc(this.getSrc());return this};var e=function(t){this._bKeyboard=t.which===r.SPACE||t.which===r.ENTER;s.prototype.onkeyup.apply(this,arguments)};var i=this;var o=new s(this.getId()+"-icon0",{decorative:false,press:function(t){i._handlePress(t,true)}});o.addStyleClass("sapUiTableActionIcon");o.setTooltip=t;o.onkeyup=e;this.addAggregation("_icons",o);o=new s(this.getId()+"-icon1",{decorative:false,press:function(t){i._handlePress(t,false)}});o.addStyleClass("sapUiTableActionIcon");o.setTooltip=t;o.onkeyup=e;this.addAggregation("_icons",o);this._iLen=0;this._iCount=2;this._aActions=["",""];this._iLastCloseTime=0};u.prototype.onAfterRendering=function(){this._updateIcons()};u.prototype.setVisible=function(t){this.setProperty("visible",t,true);this.$().toggleClass("sapUiTableActionHidden",!t);return this};u.prototype.setTooltip=function(t){this.setAggregation("tooltip",t,true);var e=this.getTooltip_AsString();if(!e){this.$().removeAttr("title")}else{this.$().attr("title",e)}return this};u.prototype.insertItem=function(t,e){this.insertAggregation("items",t,e,true);this._updateIcons(true);return this};u.prototype.addItem=function(t){this.addAggregation("items",t,true);this._updateIcons(true);return this};u.prototype.removeItem=function(t){var e=this.removeAggregation("items",t,true);this._updateIcons(true);return e};u.prototype.removeAllItems=function(){var t=this.removeAllAggregation("items",true);this._updateIcons(true);return t};u.prototype.destroyItems=function(){this.destroyAggregation("items",true);this._updateIcons(true);return this};u.prototype.getAccessibilityInfo=function(){var t=this.$().parent();var i=this.getVisible()&&this._iLen>0&&this._iCount>0&&!t.hasClass("sapUiTableRowHidden")&&!t.hasClass("sapUiTableGroupHeader")&&!t.hasClass("sapUiAnalyticalTableSum");var s;if(i){s=e.getResourceText(this._iLen==1?"TBL_ROW_ACTION_SINGLE_ACTION":"TBL_ROW_ACTION_MULTIPLE_ACTION",[this._iLen])}else{s=e.getResourceText("TBL_ROW_ACTION_NO_ACTION")}return{focusable:i,enabled:i,description:s}};u.prototype._getVisibleItems=function(t){if(!this._aVisibleItems||t){this._aVisibleItems=[];this._iLen=0;var e=this.getItems();for(var i=0;i<e.length;i++){if(e[i].getVisible()){this._aVisibleItems.push(e[i]);this._iLen++}}}return this._aVisibleItems};u.prototype._getRow=function(){return this.getParent()};u.prototype._getCount=function(){return this._iCount};u.prototype._setCount=function(t){if(t<0){this._iCount=0}else if(t>=0){this._iCount=Math.min(t,2)}this._updateIcons()};u.prototype._setFixedLayout=function(t){this._bFixedLayout=!!t;this._updateIcons()};u.prototype._setIconLabel=function(t){var e=this.getAggregation("_icons");for(var i=0;i<e.length;i++){e[i].removeAllAriaLabelledBy();if(t){e[i].addAriaLabelledBy(t)}}};u.prototype._handlePress=function(t,e){var i=e?0:1;var s=this.getAggregation("_icons")[i];var a=this._aActions[i];var r=s._bKeyboard;s._bKeyboard=false;if(a=="action"){this._getVisibleItems()[i]._doFirePress()}else if(a=="action_fixed"){this._getVisibleItems()[0]._doFirePress()}else if(a=="menu"){var l=this.getAggregation("_menu");if(!l){l=new o;this.setAggregation("_menu",l,true);l.getPopup().attachClosed(function(){this._iLastCloseTime=Date.now()},this)}l.removeAllItems();if(Date.now()-this._iLastCloseTime<500){return}var u=this.getItems();for(var p=e?0:1;p<u.length;p++){l.addItem(u[p]._getMenuItem())}l.open(!!r,s,n.Dock.EndTop,n.Dock.EndBottom,s)}};u.prototype._updateIcons=function(t){var i=this._getVisibleItems(t);var s=this.getAggregation("_icons");var o=this.$().children();function n(t){s[0].$()[t==0?"attr":"removeAttr"]("aria-haspopup",t==0?"true":undefined);s[1].$()[t==1?"attr":"removeAttr"]("aria-haspopup",t==1?"true":undefined)}if(this._bFixedLayout&&this._iLen==1&&this._iCount==2){var a=this.getItems();if(a.length>1&&i[0]===a[1]){i[0]._syncIcon(s[1]);l(o.get(0)).toggleClass("sapUiTableActionHidden",true);l(o.get(1)).toggleClass("sapUiTableActionHidden",false);n(-1);this._aActions=["","action_fixed"];return}}if(this._iLen==0||this._iCount==0){o.toggleClass("sapUiTableActionHidden",true);n(-1);this._aActions=["",""]}else if(this._iLen==1&&this._iCount>0){i[0]._syncIcon(s[0]);l(o.get(0)).toggleClass("sapUiTableActionHidden",false);l(o.get(1)).toggleClass("sapUiTableActionHidden",true);n(-1);this._aActions=["action",""]}else if(this._iLen==2&&this._iCount==2){i[0]._syncIcon(s[0]);i[1]._syncIcon(s[1]);o.toggleClass("sapUiTableActionHidden",false);n(-1);this._aActions=["action","action"]}else if(this._iLen>2&&this._iCount==2){i[0]._syncIcon(s[0]);s[1].setSrc("sap-icon://overflow");s[1].setTooltip(e.getResourceText("TBL_ROW_ACTION_MORE"));o.toggleClass("sapUiTableActionHidden",false);n(1);this._aActions=["action","menu"]}else{s[0].setSrc("sap-icon://overflow");s[0].setTooltip(e.getResourceText("TBL_ROW_ACTION_MORE"));l(o.get(0)).toggleClass("sapUiTableActionHidden",false);l(o.get(1)).toggleClass("sapUiTableActionHidden",true);n(0);this._aActions=["menu",""]}};return u});