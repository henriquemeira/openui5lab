/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/test/Opa","sap/ui/test/OpaPlugin","sap/ui/test/PageObjectFactory","sap/ui/base/Object","sap/ui/test/launchers/iFrameLauncher","sap/ui/test/launchers/componentLauncher","sap/ui/core/routing/HashChanger","sap/ui/test/matchers/Matcher","sap/ui/test/matchers/AggregationFilled","sap/ui/test/matchers/PropertyStrictEquals","sap/ui/test/pipelines/ActionPipeline","sap/ui/test/_ParameterValidator","sap/ui/test/_OpaLogger","sap/ui/thirdparty/URI","sap/ui/base/EventProvider","sap/ui/qunit/QUnitUtils","sap/ui/test/autowaiter/_autoWaiter","sap/ui/dom/includeStylesheet","sap/ui/thirdparty/jquery"],function(e,t,n,r,i,a,o,s,u,c,p,f,h,l,d,g,v,w,m){"use strict";var y=h.getLogger("sap.ui.test.Opa5"),x=new t,F=new p,E="OpaFrame",_=new f({errorPrefix:"sap.ui.test.Opa5#waitFor"}),W=["visible","viewNamespace","viewName","viewId","autoWait"].concat(e._aConfigValuesForWaitFor),C=["check","error","success"].concat(e._aConfigValuesForWaitFor),b=[],O=new d;e._extractAppParams=function(){var t=[/^opa((?!(Frame)).*)$/,/hidepassed/,/noglobals/,/notrycatch/,/coverage/,/module/,/filter/];var n={};var r=(new l).search(true);Object.keys(r).forEach(function(i){var a=false;t.forEach(function(e){if(!a&&i.match(e)){y.debug("Skipping uri parameter: "+i+" as blacklisted with pattern: "+e);a=true}});if(!a){n[i]=e._parseParam(r[i])}});return n};var A=e._extractAppParams();var P=r.extend("sap.ui.test.Opa5",m.extend({},e.prototype,{constructor:function(){e.apply(this,arguments)}}));function I(){var t=this;var n={};var r=["source","timeout","autoWait","width","height"];if(arguments.length===1&&m.isPlainObject(arguments[0])){n=arguments[0]}else{var a=arguments;r.forEach(function(e,t){n[e]=a[t]})}if(n.source&&typeof n.source!=="string"){n.source=n.source.toString()}var o=new l(n.source?n.source:"");o.search(m.extend(o.search(true),e.config.appParams));var s=k();s.success=function(){S({source:o.toString(),width:n.width||e.config.frameWidth,height:n.height||e.config.frameHeight})};this.waitFor(s);var u=k();u.check=i.hasLaunched;u.timeout=n.timeout||80;u.errorMessage="unable to load the IFrame with the url: "+n.source;t.waitFor(u);var c=k();c.success=function(){t._loadExtensions(i.getWindow())};this.waitFor(c);var p=k();p.autoWait=n.autoWait||false;p.timeout=n.timeout||80;return this.waitFor(p)}P.prototype.iStartMyUIComponent=function t(n){var r=this;var i=false;n=n||{};var s=k();s.success=function(){var t=new l;t.search(m.extend(t.search(true),e.config.appParams));window.history.replaceState({},"",t.toString())};this.waitFor(s);var u=k();u.success=function(){var e=sap.ui.require.toUrl("sap/ui/test/OpaCss")+".css";w(e);o.getInstance().setHash(n.hash||"");a.start(n.componentConfig).then(function(){i=true})};this.waitFor(u);var c=k();c.errorMessage="Unable to load the component with the name: "+n.name;c.check=function(){return i};if(n.timeout){c.timeout=n.timeout}r.waitFor(c);var p=k();p.success=function(){r._loadExtensions(window)};this.waitFor(p);var f=k();f.autoWait=n.autoWait||false;f.timeout=n.timeout||80;return this.waitFor(f)};P.prototype.iTeardownMyUIComponent=function e(){var t=k();t.success=function(){a.teardown()};var n=k();n.success=function(){var e=new l;e.search(A);window.history.replaceState({},"",e.toString())};return m.when(this.waitFor(t),this.waitFor(n))};P.prototype.iTeardownMyApp=function(){var e=this;var t=k();t.success=function(){e._unloadExtensions(P.getWindow())};var n=k();n.success=function(){if(i.hasLaunched()){this.iTeardownMyAppFrame()}else if(a.hasLaunched()){this.iTeardownMyUIComponent()}else{var e="A teardown was called but there was nothing to tear down use iStartMyComponent or iStartMyAppInAFrame";y.error(e,"Opa");throw new Error(e)}}.bind(this);return m.when(this.waitFor(t),this.waitFor(n))};P.iStartMyAppInAFrame=I;P.prototype.iStartMyAppInAFrame=I;function L(){var e=k();e.success=function(){i.teardown()};return this.waitFor(e)}P.iTeardownMyAppFrame=L;P.prototype.iTeardownMyAppFrame=L;P.prototype.hasAppStartedInAFrame=function(){return i.hasLaunched()};P.prototype.hasUIComponentStarted=function(){return a.hasLaunched()};P.prototype.hasAppStarted=function(){return i.hasLaunched()||a.hasLaunched()};P.prototype.waitFor=function(n){var r=n.actions,a=e._createFilteredConfig(W),o;n=m.extend({},a,n);n.actions=r;_.validate({validationInfo:P._validationInfo,inputToValidate:n});var s=n.check,u=null,c=n.success,p,f;o=e._createFilteredOptions(C,n);o.check=function(){var e=!!n.actions||n.autoWait;var r=P._getAutoWaiter();r.extendConfig(n.autoWait);if(e&&r.hasToWait()){return false}var a=P.getPlugin();var o=m.extend({},n,{interactable:e});p=a._getFilteredControls(o,u);if(i.hasLaunched()&&m.isArray(p)){var c=[];p.forEach(function(e){c.push(e)});p=c}if(p===t.FILTER_FOUND_NO_CONTROLS){y.debug("Matchers found no controls so check function will be skipped");return false}if(s){return this._executeCheck(s,p)}return true};o.success=function(){var t=e._getWaitForCounter();if(r&&(p||!f)){F.process({actions:r,control:p})}if(!c){return}var i=[];if(p){i.push(p)}if(t.get()===0){y.timestamp("opa.waitFor.success");y.debug("Execute success handler");c.apply(this,i);return}var a=k();if(m.isPlainObject(n.autoWait)){a.autoWait=m.extend({},n.autoWait)}else{a.autoWait=n.autoWait}a.success=function(){c.apply(this,i)};this.waitFor(a)};return e.prototype.waitFor.call(this,o)};P.getPlugin=function(){return i.getPlugin()||x};P.getJQuery=function(){return i.getJQuery()||m};P.getWindow=function(){return i.getWindow()||window};P.getUtils=function(){return i.getUtils()||g};P.getHashChanger=function(){return i.getHashChanger()||o.getInstance()};P._getAutoWaiter=function(){return i._getAutoWaiter()||v};P.extendConfig=function(t){e.extendConfig(t);e.extendConfig({appParams:A});P._getAutoWaiter().extendConfig(t.autoWait)};P.resetConfig=function(){e.resetConfig();e.extendConfig({viewNamespace:"",arrangements:new P,actions:new P,assertions:new P,visible:true,autoWait:false,_stackDropCount:1});e.extendConfig({appParams:A})};P.getTestLibConfig=function(t){return e.config.testLibs&&e.config.testLibs[t]?e.config.testLibs[t]:{}};P.emptyQueue=e.emptyQueue;P.stopQueue=e.stopQueue;P.getContext=e.getContext;P.matchers={};P.matchers.Matcher=s;P.matchers.AggregationFilled=u;P.matchers.PropertyStrictEquals=c;P.createPageObjects=function(e){return n.create(e,P)};P.prototype._executeCheck=function(e,t){var n=[];t&&n.push(t);y.debug("Executing OPA check function on controls "+t);y.debug("Check function is:\n"+e);var r=e.apply(this,n);y.debug("Result of check function is: "+r||"not defined or null");return r};P.prototype.iWaitForPromise=function(t){var n={viewName:null,controlType:null,id:null,searchOpenDialogs:false,autoWait:false};return e.prototype._schedulePromiseOnFlow.call(this,t,n)};P.resetConfig();function S(t){var n=sap.ui.require.toUrl("sap/ui/test/OpaCss")+".css";w(n);var r=m.extend({},t,{frameId:E,opaLogLevel:e.config.logLevel});return i.launch(r)}function k(){return{viewName:null,controlType:null,id:null,searchOpenDialogs:false,autoWait:false}}m(function(){if(m("#"+E).length){S()}m("body").addClass("sapUiBody");m("html").height("100%")});P._validationInfo=m.extend({_stack:"string",viewName:"string",viewNamespace:"string",viewId:"string",visible:"bool",matchers:"any",actions:"any",id:"any",controlType:"any",searchOpenDialogs:"bool",autoWait:"any"},e._validationInfo);P._getEventProvider=function(){return O};P.prototype._loadExtensions=function(t){var n=this;var r=e.config.extensions?e.config.extensions:[];var i=m.when(m.map(r,function(e){var r;var i=m.Deferred();t.sap.ui.require([e],function(a){r=new a;r.name=e;n._executeExtensionOnAfterInit(r,t).done(function(){P._getEventProvider().fireEvent("onExtensionAfterInit",{extension:r,appWindow:t});n._addExtension(r);i.resolve()}).fail(function(e){y.error(new Error("Error during extension init: "+e),"Opa");i.resolve()})});return i.promise()}));return this.iWaitForPromise(i)};P.prototype._unloadExtensions=function(e){var t=this;var n=m.when(m.map(this._getExtensions(),function(n){var r=m.Deferred();P._getEventProvider().fireEvent("onExtensionBeforeExit",{extension:n});t._executeExtensionOnBeforeExit(n,e).done(function(){r.resolve()}).fail(function(e){y.error(new Error("Error during extension init: "+e),"Opa");r.resolve()});return r.promise()}));this.iWaitForPromise(n)};P.prototype._addExtension=function(e){b.push(e)};P.prototype._getExtensions=function(){return b};P.prototype._executeExtensionOnAfterInit=function(e,t){var n=m.Deferred();var r=e.onAfterInit;if(r){r.bind(t)().done(function(){n.resolve()}).fail(function(t){n.reject(new Error("Error while waiting for extension: "+e.name+" to init, details: "+t))})}else{n.resolve()}return n.promise()};P.prototype._executeExtensionOnBeforeExit=function(e,t){var n=m.Deferred();var r=e.onBeforeExit;if(r){r.bind(t)().done(function(){n.resolve()}).fail(function(t){n.reject(new Error("Error while waiting for extension: "+e.name+" to exit, details: "+t))})}else{n.resolve()}return n.promise()};return P});