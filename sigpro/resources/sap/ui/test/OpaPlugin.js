/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
(function(t){"use strict";var e;if(t.module){e=t.module;t.module=undefined}sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Object","sap/ui/core/mvc/View","sap/ui/test/matchers/Ancestor","sap/ui/test/matchers/MatcherFactory","sap/ui/test/pipelines/MatcherPipeline","sap/ui/test/_opaCorePlugin","sap/ui/test/_OpaLogger"],function(t,e,i,n,r,o,l,s){var a=new r;var u=new o;var g=["id","viewName","viewId","controlType","searchOpenDialogs"];var c=e.extend("sap.ui.test.OpaPlugin",{constructor:function(){this._oLogger=s.getLogger("sap.ui.test.Opa5")},getAllControls:function(t,e){var i=l.getAllControls(t);this._oLogger.debug("Found "+i.length+" controls"+(t?" of type '"+(e||t)+"'":"")+" in page");return i},getView:function(t){var e=this.getAllControls(i,"View");var n=e.filter(function(e){return e.getViewName()===t});this._oLogger.debug("Found "+n.length+" views with viewName '"+t+"'");if(n.length>1){n=n.filter(function(t){var e=t.$();return e.length>0&&e.is(":visible")&&e.css("visibility")!=="hidden"});this._oLogger.debug("Found "+n.length+" visible views with viewName '"+t+"'");if(n.length!==1){this._oLogger.debug("Cannot identify controls uniquely. Please provide viewId to locate the exact view.");n=[]}}return n[0]},_getMatchingView:function(t){var e=null;var n;if(t.viewName){var r=(t.viewNamespace||"")+"."+(t.viewName||"");n=r.replace(/\.+/g,".").replace(/^\.|\.$/g,"")}if(t.viewId){var o=l.getCoreElement(t.viewId,i);if(o&&(!n||o.getViewName()===n)){e=o}}else{e=this.getView(n)}this._oLogger.debug("Found "+(e?"":"no ")+"view with ID '"+t.viewId+"' and viewName '"+n+"'");return e},getControlInView:function(e){var i=this._getMatchingView(e);var n=typeof e.id==="string";if(!i){return n?null:[]}var r=i.getViewName();if(t.isArray(e.id)){var o=[];var l=[];t.each(e.id,function(t,e){var n=i.byId(e);if(n){o.push(n)}else{l.push(e)}});var s=l.length?". Found no controls matching the subset of IDs "+l:"";this._oLogger.debug("Found "+o.length+" controls with ID contained in "+e.id+" in view '"+r+"'"+s);return o}if(n){var a=i.byId(e.id)||null;this._oLogger.debug("Found "+(a?"":"no ")+"control with ID '"+e.id+"' in view '"+r+"'");return a}var u=this.getAllControlsWithTheParent(i,e.controlType,e.sOriginalControlType);var g=t.type(e.id)==="regexp";if(g){var c=i.getId();u=u.filter(function(t){var i=t.getId().replace(c,"");return e.id.test(i)})}this._oLogger.debug("Found "+u.length+" controls of type "+e.sOriginalControlType+(g?" with ID matching "+e.id:"")+" in view '"+r+"'");return u},getAllControlsWithTheParent:function(t,e,i){var r=new n(t);return this._filterUniqueControlsByCondition(this.getAllControls(e,i),r)},getAllControlsInContainer:function(t,e,i,n){var r=this._filterUniqueControlsByCondition(this._getControlsInContainer(t),function(t){return l.checkControlType(t,e)});this._oLogger.debug("Found "+r.length+" controls in "+(n?n:"container")+" with controlType '"+i+"'");return r},_getControlsInStaticArea:function(e){var i=this._getControlsInContainer(t("#sap-ui-static"))||[];if(e.id){i=this._filterUniqueControlsByCondition(i,function(i){var n=false;var r=i.getId();var o=this._getMatchingView(e);if(o){if(this._isControlInView(i,o.getViewName())){r=r.replace(o.getId()+"--","")}}if(typeof e.id==="string"){n=r===e.id}if(t.type(e.id)==="regexp"){n=e.id.test(r)}if(t.isArray(e.id)){n=e.id.filter(function(t){return t===r}).length>0}return n}.bind(this));this._oLogger.debug("Found "+(i.length?i.length:"no")+" controls in the static area with ID matching '"+e.id+"'")}if(i.length&&e.controlType){i=this._filterUniqueControlsByCondition(i,function(t){return l.checkControlType(t,e.controlType)});this._oLogger.debug("Found "+(i.length?i.length:"no")+" controls in the static area with control type matching '"+e.controlType+"'")}if(e.id&&typeof e.id==="string"){return i[0]||null}else{return i}},_getControlsInContainer:function(t){return t.find("*").control()},_isControlInView:function(t,e){if(!t){return false}if(t.getViewName&&t.getViewName()===e){return true}else{return this._isControlInView(t.getParent(),e)}},getMatchingControls:function(e){var i=null;e=e||{};var n=this._modifyControlType(e);if(!n){return typeof e.id==="string"?i:[]}if(e.searchOpenDialogs){i=this._getControlsInStaticArea(e)}else if(e.viewName||e.viewId){i=this.getControlInView(e)}else if(e.id){i=this.getControlByGlobalId(e)}else if(e.controlType){i=this.getAllControls(e.controlType,e.sOriginalControlType)}else{i=this.getAllControls()}if(!i||e.visible===false){return i}var r=a.getInteractabilityMatchers(e.interactable);var o=u.process({control:i,matchers:r});if(!o){if(t.isArray(i)){return[]}if(i){return null}return i}return o},_getFilteredControls:function(t){var e=this._filterControlsByCondition(t);return e===c.FILTER_FOUND_NO_CONTROLS?c.FILTER_FOUND_NO_CONTROLS:this._filterControlsByMatchers(t,e)},_getFilteredControlsByDeclaration:function(e){var i=this._filterControlsByCondition(e);var n=t.extend({},e,{useDeclarativeMatchers:true});return i===c.FILTER_FOUND_NO_CONTROLS?c.FILTER_FOUND_NO_CONTROLS:this._filterControlsByMatchers(n,i)},_filterControlsByCondition:function(e){var i=null;var n=this._isLookingForAControl(e);if(n){i=this.getMatchingControls(e)}var r=[typeof e.id==="string"&&!i,t.type(e.id)==="regexp"&&!i.length,t.isArray(e.id)&&(!i||i.length!==e.id.length),e.controlType&&t.isArray(i)&&!i.length,!e.id&&(e.viewName||e.viewId||e.searchOpenDialogs)&&!i.length];return r.some(Boolean)?c.FILTER_FOUND_NO_CONTROLS:i},_filterControlsByMatchers:function(t,e){var i=t.useDeclarativeMatchers?a.getFilteringMatchers(t):t.matchers;var n=this._isLookingForAControl(t);var r=null;if((e||!n)&&i){r=u.process({matchers:i,control:e});if(!r){return c.FILTER_FOUND_NO_CONTROLS}}else{r=e}return r},getControlByGlobalId:function(e){if(typeof e.id==="string"){var i=l.getCoreElement(e.id);if(i&&!l.checkControlType(i,e.controlType)){this._oLogger.error("A control with global ID '"+e.id+"' is found but does not have required controlType '"+e.sOriginalControlType+"'. Found control is '"+i+"' but null is returned instead");return null}this._oLogger.debug("Found "+(i?"":"no ")+"control with the global ID '"+e.id+"'");return i}var n=[];var r=t.type(e.id)==="regexp";var o=l.getCoreElements();if(r){for(var s in o){if(o.hasOwnProperty(s)&&e.id.test(s)){n.push(s)}}}else if(t.isArray(e.id)){n=e.id}var a=[];var u=[];n.forEach(function(t){var i=o[t];if(i&&l.checkControlType(i,e.controlType)&&!i.bIsDestroyed){a.push(i)}else{u.push(t)}});var g=!r&&u.length?". Found no controls of matching the subset of IDs "+u:"";this._oLogger.debug("Found "+a.length+" controls of type "+e.sOriginalControlType+(r?" with ID matching '":" with ID contained in '")+e.id+g);return a},getControlConstructor:function(e){if(sap.ui.lazyRequire._isStub(e)){this._oLogger.debug("The control type "+e+" is currently a lazy stub.");return null}var i=t.sap.getObject(e);if(!i){this._oLogger.debug("The control type "+e+" is undefined.");return null}return i},_isLookingForAControl:function(t){return Object.keys(t).some(function(e){return g.indexOf(e)!==-1&&!!t[e]})},_filterUniqueControlsByCondition:function(t,e){return t.filter(function(t,i,n){var r=!!e(t);return r&&n.indexOf(t)===i})},_modifyControlType:function(t){var e=t.controlType;if(typeof e!=="string"){if(e&&e._sapUiLazyLoader){this._oLogger.debug("The control type is currently a lazy stub");return false}return true}var i=this.getControlConstructor(e);if(!i){return false}t.sOriginalControlType=e;t.controlType=i;return true}});c.FILTER_FOUND_NO_CONTROLS="FILTER_FOUND_NO_CONTROL";return c});if(e){t.module=e}})(window);