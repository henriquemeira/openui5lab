/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ODataBinding","./lib/_Cache","./lib/_Helper","sap/base/Log","sap/ui/base/SyncPromise","sap/ui/model/BindingMode","sap/ui/model/ChangeReason","sap/ui/model/odata/v4/Context","sap/ui/model/PropertyBinding"],function(e,t,o,i,n,r,a,s,h){"use strict";var d="sap.ui.model.odata.v4.ODataPropertyBinding",u=Object.freeze([]),p={AggregatedDataStateChange:true,change:true,dataReceived:true,dataRequested:true,DataStateChange:true};var l=h.extend("sap.ui.model.odata.v4.ODataPropertyBinding",{constructor:function(t,o,i,r){h.call(this,t,o);e.call(this);if(o.slice(-1)==="/"){throw new Error("Invalid path: "+o)}if(r){this.checkBindingParameters(r,["$$groupId"]);this.sGroupId=r.$$groupId}else{this.sGroupId=undefined}this.oCheckUpdateCallToken=undefined;this.mQueryOptions=this.oModel.buildQueryOptions(r,false);this.oCachePromise=n.resolve();this.fetchCache(i);this.oContext=i;this.bHasDeclaredType=undefined;this.bInitial=true;this.sPathWithFetchTypeError=undefined;this.vValue=undefined;t.bindingCreated(this)},metadata:{publicMethods:[]}});e(l.prototype);l.prototype.attachEvent=function(e){if(!(e in p)){throw new Error("Unsupported event '"+e+"': v4.ODataPropertyBinding#attachEvent")}return h.prototype.attachEvent.apply(this,arguments)};l.prototype.checkUpdate=function(e,t,h,u){var p=false,l=this.sPath.indexOf("##"),f=l>=0,c=this.oModel.getMetaModel(),g={data:{}},y=this.oModel.resolve(this.sPath,this.oContext),C={forceUpdate:y&&(e||this.oCheckUpdateCallToken&&this.oCheckUpdateCallToken.forceUpdate)},v=this.oType,M=this;this.oCheckUpdateCallToken=C;if(this.bHasDeclaredType===undefined){this.bHasDeclaredType=!!v}if(arguments.length<4){u=Promise.resolve(this.oCachePromise.then(function(e){var t,o;if(e){return e.fetchValue(M.lockGroup(h||M.getGroupId()),undefined,function(){p=true;M.fireDataRequested()},M)}if(M.bRelative&&!M.oContext){return undefined}if(M.bRelative&&M.oContext.getIndex&&M.oContext.getIndex()===s.VIRTUAL){C.forceUpdate=false}if(!f){return M.oContext.fetchValue(M.sPath,M)}t=M.sPath.slice(0,l);o=M.sPath.slice(l+2);if(o[0]==="/"){o="."+o}return c.fetchObject(o,c.getMetaContext(M.oModel.resolve(t,M.oContext)))}).then(function(e){if(!e||typeof e!=="object"){return e}if(M.sInternalType==="any"&&(M.getBindingMode()===r.OneTime||M.sPath[M.sPath.lastIndexOf("/")+1]==="#"&&!f)){if(f){return e}else if(M.bRelative){return o.publicClone(e)}}i.error("Accessed value is not primitive",y,d)},function(e){M.oModel.reportError("Failed to read path "+y,d,e);if(e.canceled){C.forceUpdate=false;return M.vValue}g={error:e}}));if(y&&!this.bHasDeclaredType&&this.sInternalType!=="any"&&!f){v=c.fetchUI5Type(y)}}return n.all([u,v]).then(function(e){var o=e[1],i=e[0];if(C===M.oCheckUpdateCallToken){M.oCheckUpdateCallToken=undefined;M.setType(o,M.sInternalType);if(C.forceUpdate||M.vValue!==i){M.bInitial=false;M.vValue=i;M._fireChange({reason:t||a.Change})}M.checkDataState()}if(p){M.fireDataReceived(g)}})};l.prototype.deregisterChange=function(){var e=this;this.withCache(function(t,o){t.deregisterChange(o,e)}).catch(function(t){e.oModel.reportError("Error in deregisterChange",d,t)})};l.prototype.destroy=function(){if(this.getBindingMode()===r.OneTime&&!this.oCachePromise){i.error("Binding already destroyed",this.sPath,d);return}this.deregisterChange();this.oModel.bindingDestroyed(this);this.oCachePromise=undefined;this.oContext=undefined;this.mQueryOptions=undefined;this.vValue=undefined;h.prototype.destroy.apply(this,arguments)};l.prototype.doCreateCache=function(e,o){return t.createProperty(this.oModel.oRequestor,e,o)};l.prototype.doFetchQueryOptions=function(){return this.isRoot()?n.resolve(this.mQueryOptions):n.resolve({})};l.prototype.getDependentBindings=function(){return u};l.prototype.getUnitOrCurrencyPath=function(){var e=this.oModel.getMetaModel(),t=this.oModel.resolve(this.sPath,this.oContext),o=e.getObject("@",e.getMetaContext(t)),i=o&&(o["@Org.OData.Measures.V1.Unit"]||o["@Org.OData.Measures.V1.ISOCurrency"]);return i&&i.$Path};l.prototype.getValue=function(){return this.vValue};l.prototype.getValueListType=function(){var e=this.getModel().resolve(this.sPath,this.oContext);if(!e){throw new Error(this+" is not resolved yet")}return this.getModel().getMetaModel().getValueListType(e)};l.prototype.hasPendingChangesInDependents=function(e){return false};l.prototype.isMeta=function(){return this.sPath.includes("##")};l.prototype.onChange=function(e){this.checkUpdate(undefined,undefined,undefined,e)};l.prototype.refreshInternal=function(e,t,o){if(this.isRootBindingSuspended()){this.sResumeChangeReason=a.Refresh;return n.resolve()}this.fetchCache(this.oContext);return o?this.checkUpdate(true,a.Refresh,t):n.resolve()};l.prototype.requestValueListInfo=function(){var e=this.getModel().resolve(this.sPath,this.oContext);if(!e){throw new Error(this+" is not resolved yet")}return this.getModel().getMetaModel().requestValueListInfo(e)};l.prototype.requestValueListType=function(){var e=this.getModel().resolve(this.sPath,this.oContext);if(!e){throw new Error(this+" is not resolved yet")}return this.getModel().getMetaModel().requestValueListType(e)};l.prototype.resetChangesInDependents=function(){};l.prototype.resetInvalidDataState=function(){if(this.getDataState().isControlDirty()){this._fireChange({reason:a.Change})}};l.prototype.resume=function(){throw new Error("Unsupported operation: resume")};l.prototype.resumeInternal=function(e){this.fetchCache(this.oContext);if(e){this.checkUpdate(false,this.sResumeChangeReason)}this.sResumeChangeReason=a.Change};l.prototype.setContext=function(e){if(this.oContext!==e){if(this.bRelative){this.deregisterChange()}this.oContext=e;if(this.bRelative){this.fetchCache(this.oContext);this.checkUpdate(false,a.Context)}}};l.prototype.setType=function(e){var t=this.oType;if(e&&e.getName()==="sap.ui.model.odata.type.DateTimeOffset"){e.setV4()}h.prototype.setType.apply(this,arguments);if(!this.bInitial&&t!==e){this._fireChange({reason:a.Change})}};l.prototype.setValue=function(e,t){var o,i=this;function n(e){i.oModel.reportError("Failed to update path "+i.oModel.resolve(i.sPath,i.oContext),d,e);return e}this.checkSuspended();this.oModel.checkGroupId(t);if(typeof e==="function"||e&&typeof e==="object"){throw n(new Error("Not a primitive value"))}if(this.vValue===undefined){throw n(new Error("Must not change a property before it has been read"))}if(this.vValue!==e){o=i.lockGroup(t,true);this.oCachePromise.then(function(t){if(t){n(new Error("Cannot set value on this binding as it is not relative"+" to a sap.ui.model.odata.v4.Context"))}else{return i.oModel.getMetaModel().fetchUpdateData(i.sPath,i.oContext).then(function(t){return i.withCache(function(r,a,s){var h=false;function d(e){n(e);if(h){s.firePatchCompleted(false);h=false}}function u(){h=true;s.firePatchSent()}o.setGroupId(s.getUpdateGroupId());return r.update(o,t.propertyPath,e,d,t.editUrl,a,i.getUnitOrCurrencyPath(),s.isPatchWithoutSideEffects(),u).then(function(){if(h){s.firePatchCompleted(true)}})},t.entityPath)})}}).catch(function(e){o.unlock(true);n(e)})}};l.prototype.suspend=function(){throw new Error("Unsupported operation: suspend")};l.prototype.visitSideEffects=function(){};return l});