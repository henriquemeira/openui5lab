/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_GroupLock","./_Helper","./_Requestor","sap/base/Log","sap/ui/base/SyncPromise","sap/ui/thirdparty/jquery"],function(e,t,n,i,s,r){"use strict";var o="@com.sap.vocabularies.Common.v1.Messages",a=/^([^(]*)(\(.*\))$/;function u(e,t,n,i){if(n.$count!==undefined){f(e,t,n,n.$count+i)}}function h(e){return e.$count!==undefined?e.$count:Infinity}function l(e,t){return t===""||e===t||e.indexOf(t+"/")===0}function f(e,n,i,s){if(typeof s==="string"){s=parseInt(s)}t.updateExisting(e,n,i,{$count:s})}function c(e,n,i,s,r){this.bActive=true;this.mChangeListeners={};this.fnGetOriginalResourcePath=r;this.sMetaPath=t.getMetaPath("/"+n);this.mPatchRequests={};this.mPostRequests={};this.oRequestor=e;this.sResourcePath=n;this.bSortExpandSelect=s;this.bSentReadRequest=false;this.oTypePromise=undefined;this.setQueryOptions(i)}c.prototype._delete=function(n,i,s,r){var o=s.split("/"),a=o.pop(),h=o.join("/"),l=this;return this.fetchValue(e.$cached,h).then(function(e){var s=a?e[a]:e,o,f=t.getPrivateAnnotation(s,"predicate"),d=t.buildPath(h,Array.isArray(e)?f:a),p=t.getPrivateAnnotation(s,"transient");if(p===true){throw new Error("No 'delete' allowed while waiting for server response")}if(p){n.unlock();l.oRequestor.removePost(p,s);return Promise.resolve()}if(s["$ui5.deleting"]){throw new Error("Must not delete twice: "+i)}s["$ui5.deleting"]=true;o={"If-Match":s};i+=l.oRequestor.buildQueryString(l.sMetaPath,l.mQueryOptions,true);return l.oRequestor.request("DELETE",i,n,o,undefined,undefined,undefined,undefined,t.buildPath(l.sResourcePath,d)).catch(function(e){if(e.status!==404){delete s["$ui5.deleting"];throw e}}).then(function(){var n;if(Array.isArray(e)){if(e[a]!==s){a=e.indexOf(s)}if(a==="-1"){delete e[-1]}else{n=t.getPrivateAnnotation(s,"predicate");if(n){delete e.$byPredicate[n]}e.splice(a,1)}u(l.mChangeListeners,h,e,-1);l.iLimit-=1;r(Number(a),e)}else{if(a){t.updateExisting(l.mChangeListeners,h,e,c.makeUpdateData([a],null))}else{s["$ui5.deleted"]=true}r()}l.oRequestor.reportBoundMessages(l.sResourcePath,[],[d])})})};c.prototype.calculateKeyPredicate=function(e,n,i){var s,r=n[i];if(r&&r.$Key){s=t.getKeyPredicate(e,i,n);if(s){t.setPrivateAnnotation(e,"predicate",s)}}return s};c.prototype.checkActive=function(){var e;if(!this.bActive){e=new Error("Response discarded: cache is inactive");e.canceled=true;throw e}};c.prototype.create=function(i,o,a,h,l,f){var c,d=h&&h["@$ui5.keepTransientPath"],p=this;function m(){t.removeByPath(p.mPostRequests,a,h);delete c[-1];l()}function P(){t.setPrivateAnnotation(h,"transient",true)}function y(n,i){var r=i.getGroupId();t.setPrivateAnnotation(h,"transient",r);t.addByPath(p.mPostRequests,a,h);return s.all([p.oRequestor.request("POST",n,i,null,h,P,m,undefined,t.buildPath(p.sResourcePath,a,"-1")),p.fetchTypes()]).then(function(e){var n=e[0],i;t.deletePrivateAnnotation(h,"transient");u(p.mChangeListeners,a,c,1);t.removeByPath(p.mPostRequests,a,h);p.visitResponse(n,e[1],t.getMetaPath(t.buildPath(p.sMetaPath,a)),a+"/-1",d);if(!d){i=t.getPrivateAnnotation(n,"predicate");if(i){c.$byPredicate[i]=h;t.updateTransientPaths(p.mChangeListeners,a,i)}}t.updateSelected(p.mChangeListeners,t.buildPath(a,i||"-1"),h,n,t.getSelectForPath(p.mQueryOptions,a));return h},function(t){if(t.canceled){throw t}f(t);return y(n,new e(p.oRequestor.getGroupSubmitMode(r)==="API"?r:"$parked."+r))})}h=r.extend(true,{},h);h=n.cleanPayload(h);c=this.fetchValue(e.$cached,a).getResult();if(!Array.isArray(c)){throw new Error("Create is only supported for collections; '"+a+"' does not reference a collection")}c[-1]=h;return o.then(function(e){e+=p.oRequestor.buildQueryString(p.sMetaPath,p.mQueryOptions,true);return y(e,i)})};c.prototype.deregisterChange=function(e,n){t.removeByPath(this.mChangeListeners,e,n)};c.prototype.drillDown=function(e,n){var r=s.resolve(e),o=false,u=this;function h(e){i.error("Failed to drill-down into "+n+", invalid segment: "+e,u.toString(),"sap.ui.model.odata.v4.lib._Cache");return undefined}function l(e,i,s){var r="",a,l;if(n[0]!=="("){r+="/"}r+=n.split("/").slice(0,s).join("/");return u.oRequestor.fetchMetadata(u.sMetaPath+t.getMetaPath(r)).then(function(n){if(!n){return h(i)}if(n.$Type==="Edm.Stream"){a=e[i+"@odata.mediaReadLink"];l=u.oRequestor.getServiceUrl();return a||l+u.sResourcePath+r}if(!o){return h(i)}if(n.$kind==="NavigationProperty"){return null}if(!n.$Type.startsWith("Edm.")){return{}}if("$DefaultValue"in n){return n.$Type==="Edm.String"?n.$DefaultValue:t.parseLiteral(n.$DefaultValue,n.$Type,r)}return null})}if(!n){return r}return n.split("/").reduce(function(e,n,i){return e.then(function(e){var s,r;if(n==="$count"){return Array.isArray(e)?e.$count:h(n)}if(e===undefined||e===null){return undefined}if(typeof e!=="object"||n==="@$ui5._"){return h(n)}r=e;o=o||t.getPrivateAnnotation(e,"transient");s=a.exec(n);if(s){if(s[1]){e=e[s[1]]}if(e){e=e.$byPredicate[s[2]]}}else{e=e[n]}return e===undefined&&n[0]!=="#"?l(r,n,i+1):e})},r)};c.prototype.fetchTypes=function(){var e,t,n=this;function i(e,t){if(t&&t.$expand){Object.keys(t.$expand).forEach(function(n){var s=e;n.split("/").forEach(function(e){s+="/"+e;r(s)});i(s,t.$expand[n])})}}function r(i){e.push(n.oRequestor.fetchTypeForPath(i).then(function(e){var s=n.oRequestor.fetchMetadata(i+"/"+o).getResult();if(s){e=Object.create(e);e[o]=s}t[i]=e;if(e&&e.$Key){e.$Key.forEach(function(e){var t,n;if(typeof e!=="string"){n=e[Object.keys(e)[0]];t=n.lastIndexOf("/");if(t>=0){r(i+"/"+n.slice(0,t))}}})}}))}if(!this.oTypePromise){e=[];t={};r(this.sMetaPath);if(this.bFetchOperationReturnType){r(this.sMetaPath+"/$Type")}i(this.sMetaPath,this.mQueryOptions);this.oTypePromise=s.all(e).then(function(){return t})}return this.oTypePromise};c.prototype.hasPendingChangesForPath=function(e){return Object.keys(this.mPatchRequests).some(function(t){return l(t,e)})||Object.keys(this.mPostRequests).some(function(t){return l(t,e)})};c.prototype.patch=function(n,i){var s=this;return this.fetchValue(e.$cached,n).then(function(e){t.updateExisting(s.mChangeListeners,n,e,i);return e})};c.prototype.registerChange=function(e,n){t.addByPath(this.mChangeListeners,e,n)};c.prototype.resetChangesForPath=function(e){var n=this;Object.keys(this.mPatchRequests).forEach(function(t){var i,s;if(l(t,e)){s=n.mPatchRequests[t];for(i=s.length-1;i>=0;i--){n.oRequestor.removePatch(s[i])}delete n.mPatchRequests[t]}});Object.keys(this.mPostRequests).forEach(function(i){var s,r,o;if(l(i,e)){s=n.mPostRequests[i];for(r=s.length-1;r>=0;r--){o=t.getPrivateAnnotation(s[r],"transient");n.oRequestor.removePost(o,s[r])}delete n.mPostRequests[i]}})};c.prototype.setActive=function(e){this.bActive=e;if(!e){this.mChangeListeners={}}};c.prototype.setQueryOptions=function(e){if(this.bSentReadRequest){throw new Error("Cannot set query options: Cache has already sent a read request")}this.mQueryOptions=e;this.sQueryString=this.oRequestor.buildQueryString(this.sMetaPath,e,false,this.bSortExpandSelect)};c.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath+this.sQueryString};c.prototype.update=function(n,o,a,u,h,l,f,d,p){var m=o.split("/"),P,y=this;return this.fetchValue(n.getUnlockedCopy(),l).then(function(g){var v=t.buildPath(l,o),R=n.getGroupId(),E,b,q,$,w,S=c.makeUpdateData(m,a);function M(){t.removeByPath(y.mPatchRequests,v,b);t.updateExisting(y.mChangeListeners,l,g,c.makeUpdateData(m,E))}function A(n,i){var r;function o(){r=y.oRequestor.getModelInterface().lockGroup(R,true,y);if(p){p()}}b=y.oRequestor.request("PATCH",h,n,{"If-Match":g},S,o,M,undefined,t.buildPath(y.sResourcePath,l),i);t.addByPath(y.mPatchRequests,v,b);return s.all([b,y.fetchTypes()]).then(function(e){var n=e[0];t.removeByPath(y.mPatchRequests,v,b);if(!d){y.visitResponse(n,e[1],t.getMetaPath(t.buildPath(y.sMetaPath,l)),l)}t.updateExisting(y.mChangeListeners,l,g,d?{"@odata.etag":n["@odata.etag"]}:n)},function(n){var i=R;t.removeByPath(y.mPatchRequests,v,b);if(n.canceled){throw n}u(n);switch(y.oRequestor.getGroupSubmitMode(R)){case"API":break;case"Auto":if(!y.oRequestor.hasChanges(R,g)){i="$parked."+R}break;default:throw n}r.unlock();r=undefined;return A(new e(i),true)}).finally(function(){if(r){r.unlock()}})}if(!g){throw new Error("Cannot update '"+o+"': '"+l+"' does not exist")}$=t.getPrivateAnnotation(g,"transient");if($){if($===true){throw new Error("No 'update' allowed while waiting for server response")}if($.indexOf("$parked.")===0){q=$;$=$.slice(8)}if($!==R){throw new Error("The entity will be created via group '"+$+"'. Cannot patch via group '"+R+"'")}}E=t.drillDown(g,m);t.updateSelected(y.mChangeListeners,l,g,S);if(f){P=f.split("/");f=t.buildPath(l,f);w=y.fetchValue(e.$cached,f).getResult();if(w===undefined){i.debug("Missing value for unit of measure "+f+" when updating "+v,y.toString(),"sap.ui.model.odata.v4.lib._Cache")}else{r.extend(true,$?g:S,c.makeUpdateData(P,w))}}if($){if(q){t.setPrivateAnnotation(g,"transient",$);y.oRequestor.relocate(q,g,$)}n.unlock();return Promise.resolve()}y.oRequestor.relocateAll("$parked."+R,g,R);h+=y.oRequestor.buildQueryString(y.sMetaPath,y.mQueryOptions,true);return A(n)})};c.prototype.visitResponse=function(e,n,i,s,r,a){var u,h=false,l={},c=this.oRequestor.getServiceUrl()+this.sResourcePath,d=this;function p(e,n,i){h=true;if(e&&e.length){l[n]=e;e.forEach(function(e){if(e.longtextUrl){e.longtextUrl=t.makeAbsolute(e.longtextUrl,i)}})}}function m(e,n){return n?t.makeAbsolute(n,e):e}function P(e,n,i,s){var r={},o,h,l,f;for(o=0;o<e.length;o++){l=e[o];h=i===""?a+o:o;if(l&&typeof l==="object"){y(l,n,i,s,h);f=t.getPrivateAnnotation(l,"predicate");if(!i){u.push(f||h.toString())}if(f){r[f]=l;e.$byPredicate=r}}}}function y(e,i,a,h,l){var c,g=n[i],v=g&&g[o]&&g[o].$Path,R;h=m(h,e["@odata.context"]);c=d.calculateKeyPredicate(e,n,i);if(l!==undefined){a=t.buildPath(a,c||l)}else if(!r&&c&&a.endsWith("/-1")){a=a.slice(0,-3)+c}if(s&&!u){u=[a]}if(v){R=t.drillDown(e,v.split("/"));if(R!==undefined){p(R,a,h)}}Object.keys(e).forEach(function(n){var s,r=i+"/"+n,o=e[n],u=t.buildPath(a,n);if(n.endsWith("@odata.mediaReadLink")){e[n]=t.makeAbsolute(o,h)}if(n.includes("@")){return}if(Array.isArray(o)){o.$count=undefined;s=e[n+"@odata.count"];if(s){f({},"",o,s)}else if(!e[n+"@odata.nextLink"]){f({},"",o,o.length)}P(o,r,u,m(h,e[n+"@odata.context"]))}else if(o&&typeof o==="object"){y(o,r,u,h)}})}if(a!==undefined){u=[];P(e.value,i||this.sMetaPath,"",m(c,e["@odata.context"]))}else if(e&&typeof e==="object"){y(e,i||this.sMetaPath,s||"",c)}if(h){this.oRequestor.reportBoundMessages(this.fnGetOriginalResourcePath?this.fnGetOriginalResourcePath(e):this.sResourcePath,l,u)}};function d(e,t,n,i){c.apply(this,arguments);this.sContext=undefined;this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.aElements.$tail=undefined;this.iLimit=Infinity;this.oSyncPromiseAll=undefined}d.prototype=Object.create(c.prototype);d.prototype.fetchValue=function(e,t,n,i){var r,o=this;e.unlock();if(!this.oSyncPromiseAll){r=this.aElements.$tail?this.aElements.concat(this.aElements.$tail):this.aElements;this.oSyncPromiseAll=s.all(r)}return this.oSyncPromiseAll.then(function(){o.checkActive();o.registerChange(t,i);return o.drillDown(o.aElements,t)})};d.prototype.fill=function(e,t,n){var i,s=Math.max(this.aElements.length,1024);if(n>s){if(this.aElements.$tail&&e){throw new Error("Cannot fill from "+t+" to "+n+", $tail already in use, # of elements is "+this.aElements.length)}this.aElements.$tail=e;n=this.aElements.length}for(i=t;i<n;i++){this.aElements[i]=e}this.oSyncPromiseAll=undefined};d.prototype.getReadRange=function(e,t,n){var i=this.aElements;function s(e,t){var n;for(n=e;n<t;n+=1){if(i[n]===undefined){return true}}return false}if(s(e+t,e+t+n/2)){t+=n}if(s(Math.max(e-n/2,0),e)){t+=n;e-=n;if(e<0){t+=e;if(isNaN(t)){t=Infinity}e=0}}return{length:t,start:e}};d.prototype.getResourcePath=function(e,t){var n=this.sQueryString?"&":"?",i=t-e,s=this.sResourcePath+this.sQueryString;if(e>0||i<Infinity){s+=n+"$skip="+e}if(i<Infinity){s+="&$top="+i}return s};d.prototype.handleResponse=function(e,n,i,s){var r,o,a,u,l,c=i.value.length;this.sContext=i["@odata.context"];o=i["@odata.count"];if(o){this.iLimit=parseInt(o);f(this.mChangeListeners,"",this.aElements,this.iLimit)}this.visitResponse(i,s,undefined,undefined,undefined,e);for(u=0;u<c;u++){a=i.value[u];this.aElements[e+u]=a;l=t.getPrivateAnnotation(a,"predicate");if(l){this.aElements.$byPredicate[l]=a}}if(c<n-e){r=Math.min(h(this.aElements),e+c);this.aElements.length=r;if(!o&&r>0&&!this.aElements[r-1]){r=undefined}f(this.mChangeListeners,"",this.aElements,r);this.iLimit=r}};d.prototype.read=function(e,t,n,i,r){var o,a,u,h,l=-1,f=this.aElements[-1]?-1:0,c,d=Math.max(e,0),p=this;if(e<f){throw new Error("Illegal index "+e+", must be >= "+f)}if(t<0){throw new Error("Illegal length "+t+", must be >= 0")}if(this.aElements.$tail){return this.aElements.$tail.then(function(){return p.read(e,t,n,i,r)})}c=this.getReadRange(e,t,n);h=Math.min(c.start+c.length,this.iLimit);a=Math.min(h,Math.max(c.start,this.aElements.length)+1);for(o=c.start;o<a;o++){if(this.aElements[o]!==undefined){if(l>=0){this.requestElements(l,o,i.getUnlockedCopy(),r);r=undefined;l=-1}}else if(l<0){l=o}}if(l>=0){this.requestElements(l,h,i.getUnlockedCopy(),r)}i.unlock();u=this.aElements.slice(d,h);if(this.aElements.$tail){u.push(this.aElements.$tail)}return s.all(u).then(function(){var t;p.checkActive();t={"@odata.context":p.sContext,value:p.aElements.slice(d,h)};t.value.$count=p.aElements.$count;if(e===-1){t.value.unshift(p.aElements[-1])}return t})};d.prototype.requestElements=function(e,t,n,i){var r,o=this;r=s.all([this.oRequestor.request("GET",this.getResourcePath(e,t),n,undefined,undefined,i),this.fetchTypes()]).then(function(n){if(o.aElements.$tail===r){o.aElements.$tail=undefined}o.handleResponse(e,t,n[0],n[1])}).catch(function(n){o.fill(undefined,e,t);throw n});this.bSentReadRequest=true;this.fill(r,e,t)};d.prototype.refreshSingle=function(e,n,i){var o=t.getPrivateAnnotation(this.aElements[n],"predicate"),a,u=this.sResourcePath+o,h=r.extend({},this.mQueryOptions),l=this;delete h["$count"];delete h["$filter"];delete h["$orderby"];u+=this.oRequestor.buildQueryString(this.sMetaPath,h,false,this.bSortExpandSelect);a=s.all([this.oRequestor.request("GET",u,e,undefined,undefined,i),this.fetchTypes()]).then(function(e){var t=e[0];l.aElements[n]=l.aElements.$byPredicate[o]=t;l.visitResponse(t,e[1],undefined,o);return t});this.bSentReadRequest=true;return a};d.prototype.refreshSingleWithRemove=function(e,n,i,s){var o=this;return this.fetchTypes().then(function(a){var h=o.aElements[n],l=t.getPrivateAnnotation(h,"predicate"),f=r.extend({},o.mQueryOptions),c=f["$filter"],d=o.sResourcePath;f["$filter"]=(c?"("+c+") and ":"")+t.getKeyFilter(h,o.sMetaPath,a);d+=o.oRequestor.buildQueryString(o.sMetaPath,f,false,o.bSortExpandSelect);o.bSentReadRequest=true;return o.oRequestor.request("GET",d,e,undefined,undefined,i).then(function(e){if(o.aElements[n]!==h){n=o.aElements.indexOf(h)}if(e.value.length>1){throw new Error("Unexpected server response, more than one entity returned.")}else if(e.value.length===0){if(n===-1){delete o.aElements[-1]}else{o.aElements.splice(n,1)}delete o.aElements.$byPredicate[l];u(o.mChangeListeners,"",o.aElements,-1);o.iLimit-=1;s(n)}else{e=e.value[0];o.aElements[n]=o.aElements.$byPredicate[l]=e;o.visitResponse(e,a,undefined,l)}})})};d.prototype.requestSideEffects=function(e,n,i,r,o){var a,u=[],h,l,f=this.aElements[-1]&&t.hasPrivateAnnotation(this.aElements[-1],"transient"),c=this.fetchTypes().getResult(),d=this,p;function m(e,n,i){delete d.aElements.$byPredicate[t.getPrivateAnnotation(n,"predicate")];delete d.aElements[e+i]}if(r<0&&f){r=0;o-=1}if(!o){if(f===false){delete this.aElements[-1]}this.aElements.length=0;this.aElements.$byPredicate={};return s.resolve()}if(r>=0&&f===false){m(0,this.aElements[-1],-1)}if(r>0){this.aElements.slice(0,r).forEach(m.bind(null,0))}if(r+o<this.aElements.length){this.aElements.slice(r+o).forEach(m.bind(null,r+o));this.aElements.length=r+o}h=t.intersectQueryOptions(this.mQueryOptions,n,this.oRequestor.getModelInterface().fetchMetadata,this.sMetaPath,i);if(!h){return s.resolve()}for(p=r;p<this.aElements.length;p+=1){a=t.getKeyFilter(this.aElements[p],this.sMetaPath,c);if(!a){return null}u.push(a)}h.$filter=u.join(" or ");t.selectKeyProperties(h,c[this.sMetaPath]);delete h.$count;delete h.$orderby;delete h.$search;l=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,h,false,true);return this.oRequestor.request("GET",l,e).then(function(e){var n,i,s,o;if(e.value.length!==u.length){throw new Error("Expected "+u.length+" row(s), but instead saw "+e.value.length)}d.visitResponse(e,c,undefined,"",false,r);for(s=0,o=e.value.length;s<o;s+=1){n=e.value[s];i=t.getPrivateAnnotation(n,"predicate");t.updateExisting(d.mChangeListeners,i,d.aElements.$byPredicate[i],n)}})};function p(e,t,n){c.call(this,e,t,n);this.oPromise=null}p.prototype=Object.create(c.prototype);p.prototype._delete=function(){throw new Error("Unsupported")};p.prototype.create=function(){throw new Error("Unsupported")};p.prototype.fetchValue=function(e,t,n,i){var r=this;r.registerChange("",i);if(this.oPromise){e.unlock()}else{this.oPromise=s.resolve(this.oRequestor.request("GET",this.sResourcePath+this.sQueryString,e,undefined,undefined,n,undefined,this.sMetaPath));this.bSentReadRequest=true}return this.oPromise.then(function(e){r.checkActive();return e.value})};p.prototype.update=function(){throw new Error("Unsupported")};function m(e,t,n,i,s,r,o,a){c.apply(this,arguments);this.bFetchOperationReturnType=a;this.sMetaPath=o||this.sMetaPath;this.bPost=r;this.bPosting=false;this.oPromise=null}m.prototype=Object.create(c.prototype);m.prototype.fetchValue=function(e,t,n,i){var r=this.sResourcePath+this.sQueryString,o=this;this.registerChange(t,i);if(this.oPromise){e.unlock()}else{if(this.bPost){throw new Error("Cannot fetch a value before the POST request")}this.oPromise=s.all([this.oRequestor.request("GET",r,e,undefined,undefined,n,undefined,this.sMetaPath),this.fetchTypes()]).then(function(e){o.visitResponse(e[0],e[1],o.bFetchOperationReturnType?o.sMetaPath+"/$Type":undefined);return e[0]});this.bSentReadRequest=true}return this.oPromise.then(function(e){o.checkActive();if(e["$ui5.deleted"]){throw new Error("Cannot read a deleted entity")}return o.drillDown(e,t)})};m.prototype.post=function(e,t,n){var i=e.getGroupId(),r="POST",o=this;if(!this.bPost){throw new Error("POST request not allowed")}if(this.bPosting){throw new Error("Parallel POST requests not allowed")}this.oRequestor.relocateAll("$parked."+i,n,i);if(t){r=t["X-HTTP-Method"]||r;delete t["X-HTTP-Method"];if(this.oRequestor.isActionBodyOptional()&&!Object.keys(t).length){t=undefined}}this.oPromise=s.all([this.oRequestor.request(r,this.sResourcePath+this.sQueryString,e,{"If-Match":n},t),this.fetchTypes()]).then(function(e){o.bPosting=false;o.visitResponse(e[0],e[1],o.bFetchOperationReturnType?o.sMetaPath+"/$Type":undefined);return e[0]},function(e){o.bPosting=false;throw e});this.bPosting=true;return this.oPromise};m.prototype.requestSideEffects=function(n,i,s,r){var o=t.intersectQueryOptions(this.mQueryOptions,i,this.oRequestor.getModelInterface().fetchMetadata,this.sMetaPath+"/$Type",s),a=this;if(!o){return this.fetchValue(e.$cached,"")}r=(r||this.sResourcePath)+this.oRequestor.buildQueryString(this.sMetaPath,o,false,true);this.oPromise=Promise.all([this.oRequestor.request("GET",r,n),this.fetchTypes(),this.fetchValue(e.$cached,"")]).then(function(e){var n=e[0],i=e[2];a.visitResponse(n,e[1]);t.updateExisting(a.mChangeListeners,"",i,n);return i});return this.oPromise};c.create=function(e,t,n,i){return new d(e,t,n,i)};c.createProperty=function(e,t,n){return new p(e,t,n)};c.createSingle=function(e,t,n,i,s,r,o,a){return new m(e,t,n,i,s,r,o,a)};c.makeUpdateData=function(e,t){return e.reduceRight(function(e,t){var n={};n[t]=e;return n},t)};return c},false);