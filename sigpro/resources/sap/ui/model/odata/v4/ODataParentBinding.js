/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ODataBinding","./lib/_Helper","sap/base/Log","sap/ui/base/SyncPromise","sap/ui/model/ChangeReason","sap/ui/thirdparty/jquery"],function(e,t,n,r,i,o){"use strict";function s(){e.call(this);this.mAggregatedQueryOptions={};this.bAggregatedQueryOptionsInitial=true;this.aChildCanUseCachePromises=[];this.iPatchCounter=0;this.bPatchSuccess=true}e(s.prototype);var a="sap.ui.model.odata.v4.ODataParentBinding";s.prototype.attachPatchCompleted=function(e,t){this.attachEvent("patchCompleted",e,t)};s.prototype.detachPatchCompleted=function(e,t){this.detachEvent("patchCompleted",e,t)};s.prototype.firePatchCompleted=function(e){if(this.iPatchCounter===0){throw new Error("Completed more PATCH requests than sent")}this.iPatchCounter-=1;this.bPatchSuccess=this.bPatchSuccess&&e;if(this.iPatchCounter===0){this.fireEvent("patchCompleted",{success:this.bPatchSuccess});this.bPatchSuccess=true}};s.prototype.attachPatchSent=function(e,t){this.attachEvent("patchSent",e,t)};s.prototype.detachPatchSent=function(e,t){this.detachEvent("patchSent",e,t)};s.prototype.firePatchSent=function(){this.iPatchCounter+=1;if(this.iPatchCounter===1){this.fireEvent("patchSent")}};s.prototype.aggregateQueryOptions=function(e,t){var n=o.extend(true,{},this.mAggregatedQueryOptions);function r(e,n,i){var o,s;function a(i){if(e.$expand[i]){return r(e.$expand[i],n.$expand[i],true)}if(t){return false}e.$expand[i]=o[i];return true}function h(n){if(e.$select.indexOf(n)<0){if(t){return false}e.$select.push(n)}return true}o=n.$expand;if(o){e.$expand=e.$expand||{};if(!Object.keys(o).every(a)){return false}}s=n.$select;if(s){e.$select=e.$select||[];if(!s.every(h)){return false}}if(n.$count){e.$count=true}return Object.keys(n).concat(Object.keys(e)).every(function(t){if(t==="$count"||t==="$expand"||t==="$select"||!i&&!(t in n)){return true}return n[t]===e[t]})}if(r(n,e)){this.mAggregatedQueryOptions=n;return true}return false};s.prototype.changeParameters=function(e){var t=o.extend(true,{},this.mParameters),n,r,s=this;function a(t){if(s.oModel.bAutoExpandSelect&&t in e){throw new Error("Cannot change $expand or $select parameter in "+"auto-$expand/$select mode: "+t+"="+JSON.stringify(e[t]))}}function h(e){if(e==="$filter"||e==="$search"){n=i.Filter}else if(e==="$orderby"&&n!==i.Filter){n=i.Sort}else if(!n){n=i.Change}}if(!e){throw new Error("Missing map of binding parameters")}a("$expand");a("$select");if(this.hasPendingChanges()){throw new Error("Cannot change parameters due to pending changes")}for(r in e){if(r.indexOf("$$")===0){throw new Error("Unsupported parameter: "+r)}if(e[r]===undefined&&t[r]!==undefined){h(r);delete t[r]}else if(t[r]!==e[r]){h(r);if(typeof e[r]==="object"){t[r]=o.extend(true,{},e[r])}else{t[r]=e[r]}}}if(n){this.createReadGroupLock(this.getGroupId(),true);this.applyParameters(t,n)}};s.prototype.checkUpdate=function(){var e=this;function t(){return r.all(e.getDependentBindings().map(function(e){return e.checkUpdate()}))}if(arguments.length>0){throw new Error("Unsupported operation: "+a+"#checkUpdate must not be"+" called with parameters")}return this.oCachePromise.then(function(n){if(n&&e.bRelative){return e.fetchResourcePath(e.oContext).then(function(r){if(n.$resourcePath===r){return t()}return e.refreshInternal("")}).catch(function(t){e.oModel.reportError("Failed to update "+e,a,t)})}return t()})};s.prototype.createInCache=function(e,n,r,i,o){var s=this;return this.oCachePromise.then(function(h){if(h){return h.create(e,n,r,i,o,function(e){s.oModel.reportError("POST on '"+n+"' failed; will be repeated automatically",a,e)}).then(function(e){if(h.$resourcePath){delete s.mCacheByResourcePath[h.$resourcePath]}return e})}return s.oContext.getBinding().createInCache(e,n,t.buildPath(s.oContext.iIndex,s.sPath,r),i,o)})};s.prototype.createReadGroupLock=function(e,t,r){var i,o=this;function s(){sap.ui.getCore().addPrerenderingTask(function(){r-=1;if(r>0){Promise.resolve().then(s)}else if(o.oReadGroupLock===i){n.debug("Timeout: unlocked "+i,null,a);i.unlock(true);o.oReadGroupLock=undefined}})}this.removeReadGroupLock();this.oReadGroupLock=i=this.lockGroup(e,t);if(t){r=2+(r||0);s()}};s.prototype.destroy=function(){this.aChildCanUseCachePromises=[]};s.prototype.deleteFromCache=function(e,n,r,i){var o=this.oCachePromise.getResult(),s;if(!this.oCachePromise.isFulfilled()){throw new Error("DELETE request not allowed")}if(o){e.setGroupId(this.getUpdateGroupId());s=e.getGroupId();if(!this.oModel.isAutoGroup(s)&&!this.oModel.isDirectGroup(s)){throw new Error("Illegal update group ID: "+s)}return o._delete(e,n,r,i)}return this.oContext.getBinding().deleteFromCache(e,n,t.buildPath(this.oContext.iIndex,this.sPath,r),i)};s.prototype.fetchIfChildCanUseCache=function(e,i,s){var h,u,c,d,p,f,l=this.oModel.getMetaModel(),g,P=this;function y(){if(f){return l.fetchObject(p.slice(0,p.lastIndexOf("/")+1))}return l.fetchObject(p).then(function(e){if(e&&e.$kind==="NavigationProperty"){return l.fetchObject(p+"/").then(function(){return e})}return e})}if(this.oOperation||i==="$count"||i.slice(-7)==="/$count"||i[0]==="@"||this.getRootBinding().isSuspended()){return r.resolve(true)}u=this.oCachePromise.isRejected()||this.oCachePromise.isFulfilled()&&!this.oCachePromise.getResult()||this.oCachePromise.isFulfilled()&&this.oCachePromise.getResult().bSentReadRequest;h=l.getMetaPath(e.getPath());d=l.getMetaPath("/"+i).slice(1);f=d[0]==="#";p=t.buildPath(h,d);g=[this.doFetchQueryOptions(this.oContext),y(),s];c=r.all(g).then(function(e){var r=e[2],i,s=e[0],c=e[1];if(P.bAggregatedQueryOptionsInitial){P.selectKeyProperties(s,h);P.mAggregatedQueryOptions=o.extend(true,{},s);P.bAggregatedQueryOptionsInitial=false}if(f){i={$select:[d.slice(1)]};return P.aggregateQueryOptions(i,u)}if(d===""||c&&(c.$kind==="Property"||c.$kind==="NavigationProperty")){i=t.wrapChildQueryOptions(h,d,r,P.oModel.oRequestor.getModelInterface().fetchMetadata);if(i){return P.aggregateQueryOptions(i,u)}return false}if(d==="value"){return P.aggregateQueryOptions(r,u)}n.error("Failed to enhance query options for auto-$expand/$select as the path '"+p+"' does not point to a property",JSON.stringify(c),a);return false});this.aChildCanUseCachePromises.push(c);this.oCachePromise=r.all([this.oCachePromise,c]).then(function(e){var t=e[0];if(t&&!t.bSentReadRequest){t.setQueryOptions(o.extend(true,{},P.oModel.mUriParameters,P.mAggregatedQueryOptions))}return t}).catch(function(e){P.oModel.reportError("Failed to update cache for binding "+P,a,e)});return c};s.prototype.getQueryOptionsForPath=function(e,n){var r;if(Object.keys(this.mParameters).length){r=this.mQueryOptions;this.oModel.getMetaModel().getMetaPath("/"+e).slice(1).split("/").some(function(e){r=r.$expand&&r.$expand[e];if(!r||r===true){r={};return true}});return o.extend(true,{},r)}n=n||this.oContext;if(!this.bRelative||!n.getQueryOptionsForPath){return{}}return n.getQueryOptionsForPath(t.buildPath(this.sPath,e))};s.prototype.hasPendingChangesInDependents=function(e){var t=e?this.oModel.getDependentBindings(e):this.getDependentBindings();return t.some(function(e){var t,n;if(e.oCachePromise.isFulfilled()){t=e.oCachePromise.getResult();if(t&&t.hasPendingChangesForPath("")){return true}}if(e.mCacheByResourcePath){n=Object.keys(e.mCacheByResourcePath).some(function(t){return e.mCacheByResourcePath[t].hasPendingChangesForPath("")});if(n){return true}}return e.hasPendingChangesInDependents()})};s.prototype.initialize=function(){if((!this.bRelative||this.oContext)&&!this.getRootBinding().isSuspended()){this._fireChange({reason:i.Change})}};s.prototype.isPatchWithoutSideEffects=function(){return!!this.mParameters.$$patchWithoutSideEffects};s.prototype.isMeta=function(){return false};s.prototype.refreshDependentBindings=function(e,t,n){return r.all(this.getDependentBindings().map(function(r){return r.refreshInternal(e,t,n)}))};s.prototype.removeReadGroupLock=function(){if(this.oReadGroupLock){this.oReadGroupLock.unlock(true);this.oReadGroupLock=undefined}};s.prototype.refreshSuspended=function(e){if(e&&e!==this.getGroupId()){throw new Error(this+": Cannot refresh a suspended binding with group ID '"+e+"' (own group ID is '"+this.getGroupId()+"')")}this.setResumeChangeReason(i.Refresh)};s.prototype.resetChangesInDependents=function(){this.getDependentBindings().forEach(function(e){var t;if(e.oCachePromise.isFulfilled()){t=e.oCachePromise.getResult();if(t){t.resetChangesForPath("")}e.resetInvalidDataState()}if(e.mCacheByResourcePath){Object.keys(e.mCacheByResourcePath).forEach(function(t){e.mCacheByResourcePath[t].resetChangesForPath("")})}e.resetChangesInDependents()})};s.prototype.resume=function(){var e=this;if(this.oOperation){throw new Error("Cannot resume an operation binding: "+this)}if(this.bRelative&&(!this.oContext||this.oContext.fetchValue)){throw new Error("Cannot resume a relative binding: "+this)}if(!this.bSuspended){throw new Error("Cannot resume a not suspended binding: "+this)}this.bSuspended=false;this.createReadGroupLock(this.getGroupId(),true,1);sap.ui.getCore().addPrerenderingTask(function(){e.resumeInternal(true)})};s.prototype.selectKeyProperties=function(e,n){t.selectKeyProperties(e,this.oModel.getMetaModel().getObject(n+"/"))};s.prototype.suspend=function(){if(this.oOperation){throw new Error("Cannot suspend an operation binding: "+this)}if(this.bRelative&&(!this.oContext||this.oContext.fetchValue)){throw new Error("Cannot suspend a relative binding: "+this)}if(this.bSuspended){throw new Error("Cannot suspend a suspended binding: "+this)}if(this.hasPendingChanges()){throw new Error("Cannot suspend a binding with pending changes: "+this)}this.bSuspended=true;if(this.oReadGroupLock){this.oReadGroupLock.unlock(true);this.oReadGroupLock=undefined}};s.prototype.updateAggregatedQueryOptions=function(e){var t=Object.keys(e),n=this;if(this.mAggregatedQueryOptions){t=t.concat(Object.keys(this.mAggregatedQueryOptions));t.forEach(function(t){if(t==="$select"||t==="$expand"){return}if(e[t]===undefined){delete n.mAggregatedQueryOptions[t]}else{n.mAggregatedQueryOptions[t]=e[t]}})}};s.prototype.visitSideEffects=function(e,n,r,i,o,s){var a=r?this.oModel.getDependentBindings(r):this.getDependentBindings();a.forEach(function(r){var a=t.buildPath(s,t.getMetaPath(r.getPath())),h;if(r.oCachePromise.getResult()){h=t.stripPathPrefix(a,n);if(h.length){o.push(r.requestSideEffects(e,h))}}else if(i[a]){o.push(r.refreshInternal("",e))}else{r.visitSideEffects(e,n,null,i,o,a)}})};function h(e){if(this){s.apply(this,arguments)}else{o.extend(e,s.prototype)}}h.prototype.destroy=s.prototype.destroy;return h},false);