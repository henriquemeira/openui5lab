/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/base/util/UriParameters","sap/ui/thirdparty/jquery","sap/ui/support/RuleAnalyzer","sap/ui/support/library"],function(e,s,t,r,i,a){"use strict";var n=s.extend("sap.ui.core.support.RuleEngineOpaExtension",{metadata:{publicMethods:["getAssertions"]},onAfterInit:function(){var e=sap.ui.getCore().getLoadedLibraries()["sap.ui.support"],s=r.Deferred();if(!e){sap.ui.require(["sap/ui/support/Bootstrap"],function(e){e.initSupportRules(["true","silent"],{onReady:function(){s.resolve()}})})}else{s.resolve()}return s.promise()},getAssertions:function(){var e=function(){return new t(window.location.href).get("sap-skip-rules-issues")=="true"};var s=function(){var e=window.parent;e._$files=e._$files||[];return e};var n={noRuleFailures:function(s){var t=r.Deferred(),s=s[0]||{},a=s["failOnAnyIssues"],n=s["failOnHighIssues"],u=s.rules,o=s.preset,l=s.metadata,p=s.executionScope;i.analyze(p,u||o,l).then(function(){var s=i.getAnalysisHistory(),r={issues:[]};if(s.length){r=s[s.length-1]}var u=r.issues.reduce(function(e,s){e[s.severity.toLowerCase()]+=1;return e},{high:0,medium:0,low:0});var o=r.issues.length===0;if(n){o=u.high===0}else if(a===false||n===false){o=true}if(e()){o=true}t.resolve({result:o,message:"Support Assistant issues found: [High: "+u.high+", Medium: "+u.medium+", Low: "+u.low+"]",expected:"0 high 0 medium 0 low",actual:u.high+" high "+u.medium+" medium "+u.low+" low"})});return t.promise()},getFinalReport:function(){var s=r.Deferred(),t=i.getFormattedAnalysisHistory(),a=i.getAnalysisHistory(),n=a.reduce(function(e,s){return e+s.issues.length},0),u=n===0,o="Support Assistant Analysis History",l=o;if(u){o+=" - no issues found"}else if(e()){u=true;o+=' - issues are found. To see them remove the "sap-skip-rules-issues=true" URI parameter'}s.resolve({result:u,message:o,actual:l,expected:t});return s.promise()},getReportAsFileInFormat:function(e){var t,n,e=e[0]||{},u=r.Deferred(),o=e["historyFormat"],l=e["fileName"];switch(o){case a.HistoryFormats.Abap:if(!l){l="abap-report.json"}n=i.getFormattedAnalysisHistory(o);break;case a.HistoryFormats.String:if(!l){l="string-report.json"}n=i.getFormattedAnalysisHistory(o);break;default:if(!l){l="report.json"}n=i.getAnalysisHistory()}t=s();t._$files.push({name:l,content:JSON.stringify(n)});u.resolve({result:true,message:"Support Assistant Analysis History was stored in window._$files with following name "+l,actual:true,expected:true});return u.promise()}};return n}});return n});