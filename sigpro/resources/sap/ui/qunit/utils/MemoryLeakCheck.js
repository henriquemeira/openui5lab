/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Core","sap/ui/base/Object","sap/ui/core/Control"],function(e,t,o,n){"use strict";e.sap.require("sap.ui.qunit.qunit-css");e.sap.require("sap.ui.thirdparty.qunit");e.sap.require("sap.ui.qunit.qunit-junit");e.sap.require("sap.ui.qunit.qunit-coverage");QUnit.config.reorder=false;var r={};sap.ui.getCore().registerPlugin({startPlugin:function(e){r.oCore=e},stopPlugin:function(){r.oCore=undefined}});function a(){return e.extend({},r.oCore.mElements)}var i=function(e){var t=e.getMetadata().getAllProperties();for(var o in t){if(e.isPropertyInitial(o)){var n=t[o];try{e[n._sMutator]("dummyValueForMemLeakTest")}catch(e){}}}if(!e.getTooltip()){e.setTooltip("test")}};var l=function(e,t,o,r){QUnit.test("Control "+e+" should not have any memory leaks",function(e){var l=t();e.ok(l,"calling fnControlFactory() should return something (a control)");e.ok(l instanceof n,"calling fnControlFactory() should return something that is really instanceof sap.ui.core.Control");if(l.placeAt&&!r){try{l.getMetadata().getRenderer()}catch(t){e.ok(false,"Error: control does not have a renderer. If this is known, please set the 'bControlCannotRender' flag when calling MemoryLeakCheck.checkControl")}}i(l);if(l.placeAt&&!r){try{l.placeAt("qunit-fixture");sap.ui.getCore().applyChanges()}catch(t){e.ok(false,"Error: control has a renderer, but could not be rendered. If this is known, please set the 'bControlCannotRender' flag when calling MemoryLeakCheck.checkControl");throw t}}if(o){o(l);sap.ui.getCore().applyChanges()}l.destroy();sap.ui.getCore().applyChanges();var u=a(),c=t();i(c);if(c.placeAt&&!r){c.placeAt("qunit-fixture");sap.ui.getCore().applyChanges();c.rerender();sap.ui.getCore().applyChanges()}if(o){o(c);sap.ui.getCore().applyChanges()}c.destroy();sap.ui.getCore().applyChanges();var f=a();s(e,f,u,"Memory leak check should not find any leftover controls after creating two instances and rendering twice"+(o?"\n(and calling fnSomeAdditionalFunction)":""))})};var s=function(e,t,o,n){var r=[];for(var a in t){if(!o[a]){r.push(t[a])}}for(var i=0;i<r.length;i++){if(typeof r[i].getText==="function"){r[i]+=" (text: '"+r[i].getText()+"')"}}n=n+(r.length>0?". LEFTOVERS: "+r.join(", "):"");e.equal(r.length,0,n)};r.checkControl=function(e,t,o,n){if(typeof e!=="string"){n=o;o=t;t=e;e="[some control, id: "+Math.random()+" - please update your test to also pass the control name]"}if(o===true||o===false){n=o;o=undefined}var i;QUnit.module("MemoryLeakCheck.checkControl: "+e,{beforeEach:function(){i=a()},afterEach:function(e){for(var t in r.oCore.mElements){if(!i[t]){var o=sap.ui.getCore().byId(t);e.ok(o.getMetadata().getName(),"Cleanup of id: "+t+", control: "+o.getMetadata().getName());o.destroy()}}}});QUnit.test("MemoryLeakCheck.checkControl(fnControlFactory) should receive a control factory",function(e){e.equal(typeof t,"function","MemoryLeakCheck should have received a control factory");e.ok(document.getElementById("qunit-fixture"),"the test page HTML should contain an element with ID 'qunit-fixture'")});l(e,t,o,n)};return r},true);