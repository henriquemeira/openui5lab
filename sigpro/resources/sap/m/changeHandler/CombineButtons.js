/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/base/util/uid","sap/ui/base/ManagedObjectObserver"],function(e,t,n){"use strict";var o={};o.applyChange=function(t,o,r){if(r.modifier.targets!=="jsControlTree"){throw new Error("Combine buttons change can't be applied on XML tree")}var i=t.getDefinition(),a=r.modifier,g=e.getViewForControl(o),c=a.bySelector(i.content.combineButtonSelectors[0],r.appComponent),u=r.appComponent,p=a.getParent(c),s,d,m,l=sap.ui.getCore().getConfiguration().getRTL(),f,b,C=[],I={menuButtonId:"",parentAggregation:"",insertIndex:0};m=i.content.combineButtonSelectors.map(function(e){return a.bySelector(e,u)});d=m[0].sParentAggregationName;I.parentAggregation=d;s=a.findIndexInParentAggregation(c);I.insertIndex=s;f=a.createControl("sap.m.Menu",r.appComponent,g,i.content.menuIdSelector);m.forEach(function(e,t){var o,c,u=e.getBindingInfo("enabled"),s=e.getAggregation("customData"),m=i.content.buttonsIdForSave[t],b=a.getProperty(e,"text");c=a.createControl("sap.m.MenuItem",r.appComponent,g,m);a.setProperty(c,"text",e.mProperties.text);a.setProperty(c,"icon",e.mProperties.icon);a.setProperty(c,"enabled",e.mProperties.enabled);c.attachPress(function(t){return e.firePress(t)});new n(function(e){a.setProperty(c,"enabled",e.current);if(u){c.bindProperty("enabled",u)}}).observe(e,{properties:["enabled"]});if(u){c.bindProperty("enabled",u)}if(b){l?C.unshift(b):C.push(b)}m.id=m.id+"-originalButtonId";o=a.createControl("sap.ui.core.CustomData",r.appComponent,g,m);a.setProperty(o,"key","originalButtonId");a.setProperty(o,"value",a.getId(e));if(s&&s.length>0){s.forEach(function(e,t){a.insertAggregation(c,"customData",e,t)})}a.removeAggregation(p,d,e);a.insertAggregation(c,"dependents",e);a.insertAggregation(c,"customData",o,0);a.insertAggregation(f,"items",c,t)});b=a.createControl("sap.m.MenuButton",r.appComponent,g,i.content.menuButtonIdSelector);I.menuButtonId=a.getId(b);a.setProperty(b,"text",C.join("/"));a.insertAggregation(b,"menu",f,0);a.insertAggregation(p,d,b,s);t.setRevertData(I);return true};o.revertChange=function(e,t,n){var o=n.modifier,r=e.getRevertData(),i=e.getDefinition(),a=r.parentAggregation,g=r.insertIndex,c=o.bySelector(r.menuButtonId,n.appComponent),u=o.getParent(c),p=i.content.combineButtonSelectors;for(var s=0;s<p.length;s++){var d=o.bySelector(p[s],n.appComponent);o.insertAggregation(u,a,d,g+s)}o.removeAggregation(u,a,c);c.destroy();e.resetRevertData();return true};o.completeChangeContent=function(e,n,o){var r=o.modifier,i=o.appComponent,a=e.getDefinition(),g=n.combineFieldIds;if(g&&g.length>=2){e.addDependentControl(g,"combinedButtons",o);a.content.combineButtonSelectors=g.map(function(e){return r.getSelector(e,i)});a.content.menuButtonIdSelector=r.getSelector(i.createId(t()),i);a.content.menuIdSelector=r.getSelector(i.createId(t()),i);a.content.buttonsIdForSave=g.map(function(){return r.getSelector(i.createId(t()),i)})}else{throw new Error("Combine buttons action cannot be completed: oSpecificChangeInfo.combineFieldIds attribute required")}};return o},true);