/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./InputBase","./Popover","sap/ui/core/Item","./ColumnListItem","./Table","./library","sap/ui/core/IconPool","sap/ui/Device","sap/ui/core/Control","./SuggestionsPopover","sap/ui/dom/containsOrEquals","sap/base/assert","./InputRenderer","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/selectText"],function(e,t,o,i,s,n,u,r,g,p,l,a,h,c){"use strict";var f=n.ListType;var d=n.InputTextFormatMode;var S=n.InputType;var _=e.extend("sap.m.Input",{metadata:{library:"sap.m",properties:{type:{type:"sap.m.InputType",group:"Data",defaultValue:S.Text},maxLength:{type:"int",group:"Behavior",defaultValue:0},dateFormat:{type:"string",group:"Misc",defaultValue:"YYYY-MM-dd",deprecated:true},showValueHelp:{type:"boolean",group:"Behavior",defaultValue:false},showSuggestion:{type:"boolean",group:"Behavior",defaultValue:false},valueHelpOnly:{type:"boolean",group:"Behavior",defaultValue:false},filterSuggests:{type:"boolean",group:"Behavior",defaultValue:true},maxSuggestionWidth:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:null},startSuggestion:{type:"int",group:"Behavior",defaultValue:1},showTableSuggestionValueHelp:{type:"boolean",group:"Behavior",defaultValue:true},description:{type:"string",group:"Misc",defaultValue:null},fieldWidth:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"50%"},valueLiveUpdate:{type:"boolean",group:"Behavior",defaultValue:false},selectedKey:{type:"string",group:"Data",defaultValue:""},textFormatMode:{type:"sap.m.InputTextFormatMode",group:"Misc",defaultValue:d.Value},textFormatter:{type:"any",group:"Misc",defaultValue:""},suggestionRowValidator:{type:"any",group:"Misc",defaultValue:""},enableSuggestionsHighlighting:{type:"boolean",group:"Behavior",defaultValue:true},autocomplete:{type:"boolean",group:"Behavior",defaultValue:true}},defaultAggregation:"suggestionItems",aggregations:{suggestionItems:{type:"sap.ui.core.Item",multiple:true,singularName:"suggestionItem"},suggestionColumns:{type:"sap.m.Column",multiple:true,singularName:"suggestionColumn",bindable:"bindable",forwarding:{getter:"_getSuggestionsTable",aggregation:"columns"}},suggestionRows:{type:"sap.m.ColumnListItem",multiple:true,singularName:"suggestionRow",bindable:"bindable",forwarding:{getter:"_getSuggestionsTable",aggregation:"items"}},_suggestionPopup:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_valueHelpIcon:{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"}},associations:{selectedItem:{type:"sap.ui.core.Item",multiple:false},selectedRow:{type:"sap.m.ColumnListItem",multiple:false}},events:{liveChange:{parameters:{value:{type:"string"},escPressed:{type:"boolean"},previousValue:{type:"string"}}},valueHelpRequest:{parameters:{fromSuggestions:{type:"boolean"}}},suggest:{parameters:{suggestValue:{type:"string"},suggestionColumns:{type:"sap.m.ListBase"}}},suggestionItemSelected:{parameters:{selectedItem:{type:"sap.ui.core.Item"},selectedRow:{type:"sap.m.ColumnListItem"}}},submit:{parameters:{value:{type:"string"}}}},designtime:"sap/m/designtime/Input.designtime"}});u.insertFontFaceStyle();_.prototype.init=function(){e.prototype.init.call(this);this._fnFilter=p._DEFAULTFILTER;this._bUseDialog=r.system.phone;this._bFullScreen=r.system.phone;this._iSetCount=0;this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.m")};_.prototype.exit=function(){e.prototype.exit.call(this);this._deregisterEvents();this.cancelPendingSuggest();if(this._iRefreshListTimeout){clearTimeout(this._iRefreshListTimeout);this._iRefreshListTimeout=null}if(this._oSuggPopover){this._oSuggPopover.destroy();this._oSuggPopover=null}};_.prototype.onBeforeRendering=function(){var t=this.getSelectedKey(),o=this.getShowValueHelp()&&this.getEnabled()&&this.getEditable(),i=this.getAggregation("_endIcon")||[],s=i[0];e.prototype.onBeforeRendering.call(this);this._deregisterEvents();if(t){this.setSelectedKey(t)}if(this.getShowSuggestion()){if(this.getShowTableSuggestionValueHelp()){this._oSuggPopover._addShowMoreButton()}else{this._oSuggPopover._removeShowMoreButton()}}if(o){s=this._getValueHelpIcon();s.setProperty("visible",true,true)}else{if(s){s.setProperty("visible",false,true)}}};_.prototype.onAfterRendering=function(){e.prototype.onAfterRendering.call(this);if(this._bUseDialog&&this.getEditable()&&this.getEnabled()){this.$().on("click",c.proxy(function(e){if(this._onclick){this._onclick(e)}if(this.getShowSuggestion()&&this._oSuggPopover&&e.target.id!=this.getId()+"-vhi"){this._oSuggPopover._oPopover.open()}},this))}};_.prototype._getDisplayText=function(e){var t=this.getTextFormatter();if(t){return t(e)}var o=e.getText(),i=e.getKey(),s=this.getTextFormatMode();switch(s){case d.Key:return i;case d.ValueKey:return o+" ("+i+")";case d.KeyValue:return"("+i+") "+o;default:return o}};_.prototype._onValueUpdated=function(e){if(this._bSelectingItem||e===this._sSelectedValue){return}var t=this.getSelectedKey(),o;if(t===""){return}if(this._hasTabularSuggestions()){o=this._oSuggPopover._oSuggestionTable&&!!this._oSuggPopover._oSuggestionTable.getSelectedItem()}else{o=this._oSuggPopover._oList&&!!this._oSuggPopover._oList.getSelectedItem()}if(o){return}this.setProperty("selectedKey","",true);this.setAssociation("selectedRow",null,true);this.setAssociation("selectedItem",null,true);this.fireSuggestionItemSelected({selectedItem:null,selectedRow:null})};_.prototype._updateSelectionFromList=function(){if(this._iPopupListSelectedIndex<0){return false}var e=this._oSuggPopover._oList.getSelectedItem();if(e){if(this._hasTabularSuggestions()){this.setSelectionRow(e,true)}else{this.setSelectionItem(e._oItem,true)}}return true};_.prototype.setSelectionItem=function(e,t){this._bSelectingItem=true;if(!e){this.setAssociation("selectedItem",null,true);return}var o=this._iSetCount,i;this.setAssociation("selectedItem",e,true);this.setProperty("selectedKey",e.getKey(),true);if(t){this.fireSuggestionItemSelected({selectedItem:e})}if(o!==this._iSetCount){i=this.getValue()}else{i=this._getDisplayText(e)}this._sSelectedValue=i;this.updateInputField(i);this._iPopupListSelectedIndex=-1;if(!(this._bUseDialog&&this instanceof sap.m.MultiInput&&this._isMultiLineMode)){this._closeSuggestionPopup()}this._bSelectingItem=false};_.prototype.setSelectedItem=function(e){if(typeof e==="string"){e=sap.ui.getCore().byId(e)}if(e!==null&&!(e instanceof o)){return this}this.setSelectionItem(e);return this};_.prototype.setSelectedKey=function(e){e=this.validateProperty("selectedKey",e);this.setProperty("selectedKey",e,true);if(this._hasTabularSuggestions()){return this}if(!e){this.setSelectionItem();return this}var t=this.getSuggestionItemByKey(e);this.setSelectionItem(t);return this};_.prototype.getSuggestionItemByKey=function(e){var t=this.getSuggestionItems()||[],o,i;for(i=0;i<t.length;i++){o=t[i];if(o.getKey()===e){return o}}};_.prototype.setSelectionRow=function(e,t){if(!e){this.setAssociation("selectedRow",null,true);return}this._bSelectingItem=true;var i,s=this.getSuggestionRowValidator();if(s){i=s(e);if(!(i instanceof o)){i=null}}var n=this._iSetCount,u="",r;this.setAssociation("selectedRow",e,true);if(i){u=i.getKey()}this.setProperty("selectedKey",u,true);if(t){this.fireSuggestionItemSelected({selectedRow:e})}if(n!==this._iSetCount){r=this.getValue()}else{if(i){r=this._getDisplayText(i)}else{r=this._fnRowResultFilter?this._fnRowResultFilter(e):p._DEFAULTRESULT_TABULAR(e)}}this._sSelectedValue=r;this.updateInputField(r);this._iPopupListSelectedIndex=-1;if(!(this._bUseDialog&&this instanceof sap.m.MultiInput&&this._isMultiLineMode)){this._closeSuggestionPopup()}this._bSelectingItem=false};_.prototype.setSelectedRow=function(e){if(typeof e==="string"){e=sap.ui.getCore().byId(e)}if(e!==null&&!(e instanceof i)){return this}this.setSelectionRow(e);return this};_.prototype._getValueHelpIcon=function(){var e=this,t=this.getAggregation("_endIcon")||[],o=t[0];if(!o){o=this.addEndIcon({id:this.getId()+"-vhi",src:u.getIconURI("value-help"),useIconTooltip:false,noTabStop:true,press:function(t){if(!e.getValueHelpOnly()){var o=this.getParent(),i;if(r.support.touch){i=o.$("inner");i.attr("readonly","readonly");o.focus();i.removeAttr("readonly")}else{o.focus()}e.bValueHelpRequested=true;e.fireValueHelpRequest({fromSuggestions:false})}}})}return o};_.prototype._fireValueHelpRequestForValueHelpOnly=function(){if(this.getEnabled()&&this.getEditable()&&this.getShowValueHelp()&&this.getValueHelpOnly()){if(r.system.phone){this.focus()}this.fireValueHelpRequest({fromSuggestions:false})}};_.prototype.ontap=function(t){e.prototype.ontap.call(this,t);this._fireValueHelpRequestForValueHelpOnly()};_.prototype.setWidth=function(t){return e.prototype.setWidth.call(this,t||"100%")};_.prototype.getWidth=function(){return this.getProperty("width")||"100%"};_.prototype.setFilterFunction=function(e){if(e===null||e===undefined){this._fnFilter=p._DEFAULTFILTER;return this}a(typeof e==="function","Input.setFilterFunction: first argument fnFilter must be a function on "+this);this._fnFilter=e;return this};_.prototype.setRowResultFunction=function(e){var t;if(e===null||e===undefined){this._fnRowResultFilter=p._DEFAULTRESULT_TABULAR;return this}a(typeof e==="function","Input.setRowResultFunction: first argument fnFilter must be a function on "+this);this._fnRowResultFilter=e;t=this.getSelectedRow();if(t){this.setSelectedRow(t)}return this};_.prototype.closeSuggestions=function(){this._closeSuggestionPopup()};_.prototype._doSelect=function(e,t){if(r.support.touch){return}var o=this._$input[0];if(o){var i=this._$input;o.focus();i.selectText(e?e:0,t?t:i.val().length)}return this};_.prototype._isSuggestionItemSelectable=function(e){return e.getVisible()&&(this._hasTabularSuggestions()||e.getType()!==f.Inactive)};_.prototype._isIncrementalType=function(){var e=this.getType();if(e==="Number"||e==="Date"||e==="Datetime"||e==="Month"||e==="Time"||e==="Week"){return true}return false};_.prototype.onsapescape=function(t){var o;if(this._oSuggPopover&&this._oSuggPopover._oPopover.isOpen()){t.originalEvent._sapui_handledByControl=true;this._iPopupListSelectedIndex=-1;this._closeSuggestionPopup();if(this._sBeforeSuggest!==undefined){if(this._sBeforeSuggest!==this.getValue()){o=this._lastValue;this.setValue(this._sBeforeSuggest);this._lastValue=o}this._sBeforeSuggest=undefined}return}if(this.getValueLiveUpdate()){this.setProperty("value",this._lastValue,true)}if(e.prototype.onsapescape){e.prototype.onsapescape.apply(this,arguments)}};_.prototype.onsapenter=function(t){this.cancelPendingSuggest();if(this._oSuggPopover&&this._oSuggPopover._oPopover.isOpen()){if(!this._updateSelectionFromList()){this._closeSuggestionPopup()}}if(e.prototype.onsapenter){e.prototype.onsapenter.apply(this,arguments)}if(this.getEnabled()&&this.getEditable()&&!(this.getValueHelpOnly()&&this.getShowValueHelp())){this.fireSubmit({value:this.getValue()})}};_.prototype.onsapfocusleave=function(o){var i=this._oSuggPopover&&this._oSuggPopover._oPopover;if(i instanceof t){if(o.relatedControlId&&l(i.getDomRef(),sap.ui.getCore().byId(o.relatedControlId).getFocusDomRef())){this._bPopupHasFocus=true;this.focus()}else{if(this.getDOMValue()===this._sSelectedSuggViaKeyboard){this._sSelectedSuggViaKeyboard=null}}}var s=sap.ui.getCore().byId(o.relatedControlId);if(!(i&&s&&l(i.getDomRef(),s.getFocusDomRef()))){e.prototype.onsapfocusleave.apply(this,arguments)}this.bValueHelpRequested=false};_.prototype.onmousedown=function(e){var o=this._oSuggPopover&&this._oSuggPopover._oPopover;if(o instanceof t&&o.isOpen()){e.stopPropagation()}};_.prototype._deregisterEvents=function(){if(this._oSuggPopover){this._oSuggPopover._deregisterResize()}if(this._bUseDialog&&this._oSuggPopover&&this._oSuggPopover._oPopover){this.$().off("click")}};_.prototype.updateSuggestionItems=function(){this._bSuspendInvalidate=true;this.updateAggregation("suggestionItems");this._synchronizeSuggestions();this._bSuspendInvalidate=false;return this};_.prototype.invalidate=function(){if(!this._bSuspendInvalidate){g.prototype.invalidate.apply(this,arguments)}};_.prototype.cancelPendingSuggest=function(){if(this._iSuggestDelay){clearTimeout(this._iSuggestDelay);this._iSuggestDelay=null}};_.prototype._triggerSuggest=function(e){this.cancelPendingSuggest();this._bShouldRefreshListItems=true;if(!e){e=""}if(e.length>=this.getStartSuggestion()){this._iSuggestDelay=setTimeout(function(){if(this._sPrevSuggValue!==e){this._bBindingUpdated=false;this.fireSuggest({suggestValue:e});if(!this._bBindingUpdated){this._refreshItemsDelayed()}this._sPrevSuggValue=e}}.bind(this),300)}else if(this._bUseDialog){if(this._oSuggPopover._oList instanceof s){this._oSuggPopover._oList.addStyleClass("sapMInputSuggestionTableHidden")}else if(this._oSuggPopover._oList&&this._oSuggPopover._oList.destroyItems){this._oSuggPopover._oList.destroyItems()}}else if(this._oSuggPopover&&this._oSuggPopover._oPopover.isOpen()){setTimeout(function(){var e=this.getDOMValue()||"";if(e<this.getStartSuggestion()){this._iPopupListSelectedIndex=-1;this._closeSuggestionPopup()}}.bind(this),0)}};(function(){_.prototype.setShowSuggestion=function(e){this.setProperty("showSuggestion",e,true);this._iPopupListSelectedIndex=-1;if(e){this._oSuggPopover=this._getSuggestionsPopover()}else{this._oSuggPopover&&this._oSuggPopover._destroySuggestionPopup()}return this};_.prototype.setShowTableSuggestionValueHelp=function(e){this.setProperty("showTableSuggestionValueHelp",e,true);if(!(this._oSuggPopover&&this._oSuggPopover._oPopover)){return this}if(e){this._oSuggPopover._addShowMoreButton()}else{this._oSuggPopover._removeShowMoreButton()}return this};_.prototype.oninput=function(t){e.prototype.oninput.call(this,t);if(t.isMarked("invalid")){return}var o=this.getDOMValue();if(this.getValueLiveUpdate()){this.setProperty("value",o,true);this._onValueUpdated(o)}this.fireLiveChange({value:o,newValue:o});if(this.getShowSuggestion()&&!this._bUseDialog){this._triggerSuggest(o)}};_.prototype.getValue=function(){return this.getDomRef("inner")&&this._$input?this.getDOMValue():this.getProperty("value")};_.prototype._refreshItemsDelayed=function(){clearTimeout(this._iRefreshListTimeout);this._iRefreshListTimeout=setTimeout(function(){if(this._oSuggPopover){this._oSuggPopover._refreshListItems()}}.bind(this),0)};_.prototype.addSuggestionItem=function(e){this.addAggregation("suggestionItems",e,true);if(this._oSuggPopover){this._synchronizeSuggestions();this._oSuggPopover._createSuggestionPopupContent()}return this};_.prototype.insertSuggestionItem=function(e,t){this.insertAggregation("suggestionItems",t,e,true);if(this._oSuggPopover){this._synchronizeSuggestions();this._oSuggPopover._createSuggestionPopupContent()}return this};_.prototype.removeSuggestionItem=function(e){var t=this.removeAggregation("suggestionItems",e,true);this._synchronizeSuggestions();return t};_.prototype.removeAllSuggestionItems=function(){var e=this.removeAllAggregation("suggestionItems",true);this._synchronizeSuggestions();return e};_.prototype.destroySuggestionItems=function(){this.destroyAggregation("suggestionItems",true);this._synchronizeSuggestions();return this};_.prototype.addSuggestionRow=function(e){e.setType(f.Active);this.addAggregation("suggestionRows",e);this._synchronizeSuggestions();this._oSuggPopover._createSuggestionPopupContent();return this};_.prototype.insertSuggestionRow=function(e,t){e.setType(f.Active);this.insertAggregation("suggestionRows",e,t);this._synchronizeSuggestions();this._oSuggPopover._createSuggestionPopupContent();return this};_.prototype.removeSuggestionRow=function(e){var t=this.removeAggregation("suggestionRows",e);this._synchronizeSuggestions();return t};_.prototype.removeAllSuggestionRows=function(){var e=this.removeAllAggregation("suggestionRows");this._synchronizeSuggestions();return e};_.prototype.destroySuggestionRows=function(){this.destroyAggregation("suggestionRows");this._synchronizeSuggestions();return this};_.prototype.bindAggregation=function(){if(arguments[0]==="suggestionRows"||arguments[0]==="suggestionColumns"||arguments[0]==="suggestionItems"){this._getSuggestionsPopover()._createSuggestionPopupContent(arguments[0]==="suggestionRows"||arguments[0]==="suggestionColumns");this._bBindingUpdated=true}return e.prototype.bindAggregation.apply(this,arguments)};_.prototype._closeSuggestionPopup=function(){if(this._oSuggPopover){this._bShouldRefreshListItems=false;this.cancelPendingSuggest();this._oSuggPopover._oPopover.close();if(!this._bUseDialog&&this.$().hasClass("sapMInputFocused")){this.openValueStateMessage()}this.$("SuggDescr").text("");this.$("inner").removeAttr("aria-haspopup");this.$("inner").removeAttr("aria-activedescendant");this._sPrevSuggValue=null}};_.prototype._synchronizeSuggestions=function(){this._bShouldRefreshListItems=true;this._refreshItemsDelayed();if(!this.getDomRef()||this._oSuggestionPopup&&this._oSuggestionPopup.isOpen()){return}this._synchronizeSelection()};_.prototype._synchronizeSelection=function(){var e=this.getSelectedKey();if(!e){return}if(this.getValue()&&!this.getSelectedItem()&&!this.getSelectedRow()){return}this.setSelectedKey(e)}})();_.prototype.onfocusin=function(t){e.prototype.onfocusin.apply(this,arguments);this.$().addClass("sapMInputFocused");if(!this._bUseDialog&&this._oSuggPopover&&this._oSuggPopover._oPopover&&this._oSuggPopover._oPopover.isOpen()){this.closeValueStateMessage()}if(!this._bPopupHasFocus&&!this.getStartSuggestion()&&!this.getValue()){this._triggerSuggest(this.getValue())}this._bPopupHasFocus=undefined;this._sPrevSuggValue=null};_.prototype.onsapshow=function(e){if(!this.getEnabled()||!this.getEditable()||!this.getShowValueHelp()){return}this.bValueHelpRequested=true;this.fireValueHelpRequest({fromSuggestions:false});e.preventDefault();e.stopPropagation()};_.prototype.onsaphide=_.prototype.onsapshow;_.prototype.onsapselect=function(e){this._fireValueHelpRequestForValueHelpOnly()};_.prototype.onfocusout=function(t){e.prototype.onfocusout.apply(this,arguments);this.$().removeClass("sapMInputFocused");this.closeValueStateMessage(this)};_.prototype._hasTabularSuggestions=function(){return!!(this.getAggregation("suggestionColumns")&&this.getAggregation("suggestionColumns").length)};_.prototype._getSuggestionsTable=function(){return this._getSuggestionsPopover()._getSuggestionsTable()};_.prototype.clone=function(){var e=g.prototype.clone.apply(this,arguments),t;t=this.getBindingInfo("suggestionColumns");if(t){e.bindAggregation("suggestionColumns",c.extend({},t))}t=this.getBindingInfo("suggestionRows");if(t){e.bindAggregation("suggestionRows",c.extend({},t))}e.setRowResultFunction(this._fnRowResultFilter);return e};_.prototype.setValue=function(t){this._iSetCount++;e.prototype.setValue.call(this,t);this._onValueUpdated(t);return this};_.prototype.setDOMValue=function(e){this._$input.val(e)};_.prototype.getDOMValue=function(){return this._$input.val()};_.prototype.updateInputField=function(e){if(this._oSuggPopover&&this._oSuggPopover._oPopover.isOpen()&&this._bUseDialog){this._oSuggPopover._oPopupInput.setValue(e);this._oSuggPopover._oPopupInput._doSelect()}else{e=this._getInputValue(e);this.setDOMValue(e);this.onChange(null,null,e)}};_.prototype.getAccessibilityInfo=function(){var t=e.prototype.getAccessibilityInfo.apply(this,arguments);t.description=((t.description||"")+" "+this.getDescription()).trim();return t};_.prototype.preventChangeOnFocusLeave=function(e){return this.bFocusoutDueRendering||this.bValueHelpRequested};_.prototype._getSuggestionsPopover=function(){if(!this._oSuggPopover){this._oSuggPopover=new p(this);this._oSuggPopover._createSuggestionPopup();this._oSuggestionPopup=this._oSuggPopover._oPopover}return this._oSuggPopover};return _});