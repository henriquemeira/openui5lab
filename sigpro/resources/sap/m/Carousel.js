/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/ui/core/Control","sap/ui/Device","sap/ui/core/ResizeHandler","sap/ui/core/library","sap/ui/core/HTML","sap/m/ScrollContainer","sap/ui/core/theming/Parameters","sap/ui/dom/units/Rem","./CarouselRenderer","./CarouselLayout","sap/ui/events/KeyCodes","sap/base/Log","sap/ui/events/F6Navigation","sap/ui/thirdparty/jquery","sap/ui/thirdparty/mobify-carousel","sap/ui/core/IconPool"],function(e,t,s,i,o,a,r,n,u,h,l,p,f,g,c){"use strict";var d=o.BusyIndicatorSize;var _=e.ImageHelper;var y=e.CarouselArrowsPlacement;var m=e.PlacementType;var C=t.extend("sap.m.Carousel",{metadata:{library:"sap.m",designtime:"sap/m/designtime/Carousel.designtime",properties:{height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},loop:{type:"boolean",group:"Misc",defaultValue:false},showPageIndicator:{type:"boolean",group:"Appearance",defaultValue:true},pageIndicatorPlacement:{type:"sap.m.PlacementType",group:"Appearance",defaultValue:m.Bottom},showBusyIndicator:{type:"boolean",group:"Appearance",defaultValue:true,deprecated:true},arrowsPlacement:{type:"sap.m.CarouselArrowsPlacement",group:"Appearance",defaultValue:y.Content}},defaultAggregation:"pages",aggregations:{pages:{type:"sap.ui.core.Control",multiple:true,singularName:"page"},customLayout:{type:"sap.m.CarouselLayout",multiple:false}},associations:{activePage:{type:"sap.ui.core.Control",multiple:false}},events:{loadPage:{deprecated:true,parameters:{pageId:{type:"string"}}},unloadPage:{deprecated:true,parameters:{pageId:{type:"string"}}},pageChanged:{parameters:{oldActivePageId:{type:"string"},newActivePageId:{type:"string"},activePages:{type:"array"}}}}}});C._INNER_SELECTOR=".sapMCrslInner";C._PAGE_INDICATOR_SELECTOR=".sapMCrslBulleted";C._PAGE_INDICATOR_ARROWS_SELECTOR=".sapMCrslIndicatorArrow";C._CONTROLS=".sapMCrslControls";C._ITEM_SELECTOR=".sapMCrslItem";C._LEFTMOST_CLASS="sapMCrslLeftmost";C._RIGHTMOST_CLASS="sapMCrslRightmost";C._LATERAL_CLASSES="sapMCrslLeftmost sapMCrslRightmost";C._MODIFIERNUMBERFORKEYBOARDHANDLING=10;C._BULLETS_TO_NUMBERS_THRESHOLD=9;C._PREVIOUS_CLASS_ARROW="sapMCrslPrev";C._NEXT_CLASS_ARROW="sapMCrslNext";C.prototype.init=function(){this._aScrollContainers=[];this._fnAdjustAfterResize=c.proxy(function(){var e=this.$().find(C._INNER_SELECTOR);this._oMobifyCarousel.resize(e);this._setWidthOfPages(this._getNumberOfItemsToShow())},this);this._aOrderOfFocusedElements=[];this._aAllActivePages=[];this._aAllActivePagesIndexes=[];this.data("sap-ui-fastnavgroup","true",true)};C.prototype.exit=function(){if(this._oMobifyCarousel){this._oMobifyCarousel.destroy();delete this._oMobifyCarousel}if(this._oArrowLeft){this._oArrowLeft.destroy();delete this._oArrowLeft}if(this._oArrowRight){this._oArrowRight.destroy();delete this._oArrowRight}if(this._sResizeListenerId){i.deregister(this._sResizeListenerId);this._sResizeListenerId=null}this.$().off("afterSlide");this._cleanUpScrollContainer();this._fnAdjustAfterResize=null;this._aScrollContainers=null;this._$InnerDiv=null;this._aOrderOfFocusedElements=null;this._aAllActivePages=null;this._aAllActivePagesIndexes=null};C.prototype._cleanUpScrollContainer=function(){var e;while(this._aScrollContainers&&this._aScrollContainers.length>0){e=this._aScrollContainers.pop();e.destroyContent();if(e&&typeof e.destroy==="function"){e.destroy()}}};C.prototype.ontouchstart=function(e){if(this._oMobifyCarousel){this._oMobifyCarousel.touchstart(e)}};C.prototype.ontouchmove=function(e){if(this._oMobifyCarousel){this._oMobifyCarousel.touchmove(e)}};C.prototype.ontouchend=function(e){if(this._oMobifyCarousel){this._oMobifyCarousel.touchend(e)}};C.prototype.onBeforeRendering=function(){var e=this.getActivePage();if(!e&&this.getPages().length>0){this.setAssociation("activePage",this.getPages()[0].getId(),true)}if(this._sResizeListenerId){i.deregister(this._sResizeListenerId);this._sResizeListenerId=null}return this};C.prototype._getNumberOfItemsToShow=function(){var e=this.getPages().length,t=this.getCustomLayout(),s=1;if(t&&t.isA("sap.m.CarouselLayout")){s=Math.max(t.getVisiblePagesCount(),1)}if(s>1&&e<s){return e}return s};C.prototype.onAfterRendering=function(){var e=this._getNumberOfItemsToShow();if(this._oMobifyCarousel){this._oMobifyCarousel.unbind()}this.$().carousel(undefined,{numberOfItemsToShow:e});this._oMobifyCarousel=this.getDomRef()._carousel;this._oMobifyCarousel.setLoop(this.getLoop());this._oMobifyCarousel.setRTL(sap.ui.getCore().getConfiguration().getRTL());if(e>1){this._setWidthOfPages(e)}var t=this.getActivePage();if(t){var s=this._getPageNumber(t);if(isNaN(s)||s==0){if(this.getPages().length>0){this.setAssociation("activePage",this.getPages()[0].getId(),true);this._adjustHUDVisibility(1)}}else{var o=sap.ui.getCore();if(o.isThemeApplied()){this._moveToPage(s+1)}else{o.attachThemeChanged(this._handleThemeLoad,this)}if(this.getParent()&&this.getParent().isA("sap.zen.commons.layout.PositionContainer")){if(this._isCarouselUsedWithCommonsLayout===undefined){setTimeout(this["invalidate"].bind(this),0);this._isCarouselUsedWithCommonsLayout=true}}}}this.$().on("afterSlide",c.proxy(function(e,t,s){if(e.target!==this.getDomRef()){return}if(s>0){this._changePage(s)}},this));this._$InnerDiv=this.$().find(C._INNER_SELECTOR)[0];this._sResizeListenerId=i.register(this._$InnerDiv,this._fnAdjustAfterResize);this.$().find(".sapMCrslItemTableCell").focus(function(e){e.preventDefault();c(e.target).parents(".sapMCrsl").focus();return false});var a="sap.m.IconTabBar";var r=this.getParent();while(r){if(r.getMetadata().getName()==a){var n=this;r.attachExpand(function(e){var t=e.getParameter("expand");if(t&&s>0){n._moveToPage(s+1)}});break}r=r.getParent()}};C.prototype._setWidthOfPages=function(e){var t=this._calculatePagesWidth(e);this.$().find(".sapMCrslItem").each(function(e,s){s.style.width=t+"%"})};C.prototype._calculatePagesWidth=function(e){var t=this.$().width(),s=u.toPx(n.get("_sap_m_Carousel_PagesMarginRight")),i=(t-s*(e-1))/e,o=i/t*100;return o};C.prototype._handleThemeLoad=function(){var e,t=this.getActivePage();if(t){var s=this._getPageNumber(t);if(s>0){this._moveToPage(s+1)}}e=sap.ui.getCore();e.detachThemeChanged(this._handleThemeLoad,this)};C.prototype._moveToPage=function(e){this._oMobifyCarousel.changeAnimation("sapMCrslNoTransition");this._oMobifyCarousel.move(e);this._changePage(e)};C.prototype._changePage=function(e){this._adjustHUDVisibility(e);var t=this.getActivePage();var i=this.getPages()[e-1].getId();this._updateActivePages(i);this.setAssociation("activePage",i,true);var o=this._getPageIndicatorText(e);f.debug("sap.m.Carousel: firing pageChanged event: old page: "+t+", new page: "+i);if(!s.system.desktop){c(document.activeElement).blur()}this.firePageChanged({oldActivePageId:t,newActivePageId:i,activePages:this._aAllActivePagesIndexes});this.$("slide-number").text(o)};C.prototype._getPageIndicatorText=function(e){return sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("CAROUSEL_PAGE_INDICATOR_TEXT",[e,this.getPages().length-this._getNumberOfItemsToShow()+1])};C.prototype._adjustHUDVisibility=function(e){var t=this._getNumberOfItemsToShow();if(s.system.desktop&&!this.getLoop()&&this.getPages().length>1){var i=this.$("hud");i.removeClass(C._LATERAL_CLASSES);if(e===1){i.addClass(C._LEFTMOST_CLASS);this._focusCarouselContainer(i,C._PREVIOUS_CLASS_ARROW)}if(e+t-1===this.getPages().length){i.addClass(C._RIGHTMOST_CLASS);this._focusCarouselContainer(i,C._NEXT_CLASS_ARROW)}}};C.prototype._focusCarouselContainer=function(e,t){if(e.find("."+t)[0]===document.activeElement){this.focus()}};C.prototype.setActivePage=function(e){var s=null;if(typeof e=="string"){s=e}else if(e instanceof t){s=e.getId()}if(s){if(s===this.getActivePage()){return this}var i=this._getPageNumber(s);if(!isNaN(i)){if(this._oMobifyCarousel){this._oMobifyCarousel.move(i+1)}}}this.setAssociation("activePage",s,true);return this};C.prototype.setHeight=function(e){this.setProperty("height",e,true);this.$().css("height",e);return this};C.prototype.setWidth=function(e){this.setProperty("width",e,true);this.$().css("width",e);return this};C.prototype.setLoop=function(e){this.setProperty("loop",e,true);if(this._oMobifyCarousel){this._oMobifyCarousel.setLoop(e)}return this};C.prototype._getNavigationArrow=function(e){var t={src:"sap-icon://slim-arrow-"+e,useIconTooltip:false};if(e==="left"){if(!this._oArrowLeft){this._oArrowLeft=_.getImageControl(this.getId()+"-arrowScrollLeft",this._oArrowLeft,this,t)}return this._oArrowLeft}else if(e==="right"){if(!this._oArrowRight){this._oArrowRight=_.getImageControl(this.getId()+"-arrowScrollRight",this._oArrowRight,this,t)}return this._oArrowRight}};C.prototype._createScrollContainer=function(e){var t;var i=s.system.desktop&&this.getArrowsPlacement()===y.PageIndicator;if(i){t="sapMCrslImg"}else{t="sapMCrslImgNoArrows"}var o=e.isA("sap.m.Image")?"sapMCrslItemTableCell "+t:"sapMCrslItemTableCell",n=new a({content:"<div class='sapMCrslItemTable'>"+"<div class='"+o+"'></div>"+"</div>",afterRendering:function(t){var s=sap.ui.getCore().createRenderManager();e.addStyleClass("sapMCrsPage");s.render(e,this.getDomRef().firstChild);s.destroy();e=null}});var u=new r({horizontal:false,vertical:false,content:[n],width:"100%",height:"100%"});u.setParent(this,null,true);this._aScrollContainers.push(u);return u};C.prototype.previous=function(){if(this._oMobifyCarousel){this._oMobifyCarousel.prev()}else{f.warning("Unable to execute sap.m.Carousel.previous: carousel must be rendered first.")}return this};C.prototype.next=function(){if(this._oMobifyCarousel){this._oMobifyCarousel.next()}else{f.warning("Unable to execute sap.m.Carousel.next: carousel must be rendered first.")}return this};C.prototype._getPageNumber=function(e){var t,s;for(t=0;t<this.getPages().length;t++){if(this.getPages()[t].getId()==e){s=t;break}}return s};C.prototype.onsaptabprevious=function(e){this._bDirection=false;this._fnOnTabPress(e)};C.prototype.onsaptabnext=function(e){this._bDirection=true;this._fnOnTabPress(e)};C.prototype.onfocusin=function(e){this.saveLastFocusReference(e);this._bDirection=undefined};C.prototype.onsapskipforward=function(e){e.preventDefault();this._handleGroupNavigation(e,false)};C.prototype.onsapskipback=function(e){e.preventDefault();this._handleGroupNavigation(e,true)};C.prototype.onkeydown=function(e){if(e.keyCode==p.F7){this._handleF7Key(e);return}if(e.target!=this.getDomRef()){return}switch(e.keyCode){case 189:case p.NUMPAD_MINUS:this._fnSkipToIndex(e,-1);break;case p.PLUS:case p.NUMPAD_PLUS:this._fnSkipToIndex(e,1);break}};C.prototype.onsapescape=function(e){var t;if(e.target===this.$()[0]&&this._lastActivePageNumber){t=this._lastActivePageNumber+1;this._oMobifyCarousel.move(t);this._changePage(t)}};C.prototype.onsapright=function(e){this._fnSkipToIndex(e,1)};C.prototype.onsapup=function(e){this._fnSkipToIndex(e,-1)};C.prototype.onsapleft=function(e){this._fnSkipToIndex(e,-1)};C.prototype.onsapdown=function(e){this._fnSkipToIndex(e,1)};C.prototype.onsaphome=function(e){this._fnSkipToIndex(e,0)};C.prototype.onsapend=function(e){this._fnSkipToIndex(e,this.getPages().length)};C.prototype.onsaprightmodifiers=function(e){if(e.ctrlKey){this._fnSkipToIndex(e,C._MODIFIERNUMBERFORKEYBOARDHANDLING)}};C.prototype.onsapupmodifiers=function(e){if(e.ctrlKey){this._fnSkipToIndex(e,C._MODIFIERNUMBERFORKEYBOARDHANDLING)}};C.prototype.onsappageup=function(e){this._fnSkipToIndex(e,C._MODIFIERNUMBERFORKEYBOARDHANDLING)};C.prototype.onsapleftmodifiers=function(e){if(e.ctrlKey){this._fnSkipToIndex(e,-C._MODIFIERNUMBERFORKEYBOARDHANDLING)}};C.prototype.onsapdownmodifiers=function(e){if(e.ctrlKey){this._fnSkipToIndex(e,-C._MODIFIERNUMBERFORKEYBOARDHANDLING)}};C.prototype.onsappagedown=function(e){this._fnSkipToIndex(e,-C._MODIFIERNUMBERFORKEYBOARDHANDLING)};C.prototype._fnOnTabPress=function(e){if(e.target===this.$()[0]){this._lastActivePageNumber=this._getPageNumber(this.getActivePage())}};C.prototype._handleGroupNavigation=function(e,t){var s=c.Event("keydown");e.preventDefault();this.$().focus();s.target=e.target;s.keyCode=p.F6;s.shiftKey=t;g.handleF6GroupNavigation(s)};C.prototype.saveLastFocusReference=function(e){var t=c(e.target).closest(".sapMCrsPage").control(0),s;if(this._bDirection===undefined){return}if(this._lastFocusablePageElement===undefined){this._lastFocusablePageElement={}}if(t){s=t.getId();this._lastFocusablePageElement[s]=e.target;this._updateFocusedPagesOrder(s)}};C.prototype._getActivePageLastFocusedElement=function(){if(this._lastFocusablePageElement){return this._lastFocusablePageElement[this._getLastFocusedActivePage()]}};C.prototype._updateFocusedPagesOrder=function(e){var t=this._aOrderOfFocusedElements.indexOf(e);if(t>-1){this._aOrderOfFocusedElements.splice(0,0,this._aOrderOfFocusedElements.splice(t,1)[0])}else{this._aOrderOfFocusedElements.unshift(e)}};C.prototype._updateActivePages=function(e){var t=this._getPageNumber(e),s=this._getNumberOfItemsToShow(),i=t+s,o=this.getPages();if(i>o.length){i=o.length-s}this._aAllActivePages=[];this._aAllActivePagesIndexes=[];for(var a=t;a<i;a++){this._aAllActivePages.push(o[a].getId());this._aAllActivePagesIndexes.push(a)}};C.prototype._getLastFocusedActivePage=function(){for(var e=0;e<this._aOrderOfFocusedElements.length;e++){var t=this._aOrderOfFocusedElements[e];if(this._aAllActivePages.indexOf(t)>-1){return t}}return this.getActivePage()};C.prototype._fnSkipToIndex=function(e,t){var s=t;if(e.target!==this.getDomRef()){return}e.preventDefault();if(t!==0){s=this._getPageNumber(this.getActivePage())+1+t}this._oMobifyCarousel.move(s)};C.prototype._handleF7Key=function(e){var t;e.preventDefault();t=this._getActivePageLastFocusedElement();if(e.target===this.$()[0]&&t){t.focus()}else{this.$().focus()}};C.prototype.setShowBusyIndicator=function(){f.warning("sap.m.Carousel: Deprecated function 'setShowBusyIndicator' called. Does nothing.");return this};C.prototype.getShowBusyIndicator=function(){f.warning("sap.m.Carousel: Deprecated function 'getShowBusyIndicator' called. Does nothing.");return false};C.prototype.setBusyIndicatorSize=function(e){if(!(e in d)){e=d.Medium}return t.prototype.setBusyIndicatorSize.call(this,e)};return C});